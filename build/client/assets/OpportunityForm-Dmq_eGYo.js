var K=Object.defineProperty;var W=(a,e,r)=>e in a?K(a,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):a[e]=r;var R=(a,e,r)=>W(a,typeof e!="symbol"?e+"":e,r);import{r as F,u as X,j as n}from"./chunk-PVWAREVJ-xN2wnjH-.js";import{I as C,T as N,S as Y}from"./Inputs-nFJy7MmX.js";import{S as Z}from"./StatusOptions-BwlUIHMm.js";import{a as Q}from"./Cards-BrE1Rw6C.js";import{u as D}from"./index.esm-BDlKQGcf.js";import{u as ee}from"./UIContext-CTPOFttf.js";import{b as re,o as P,e as ae,g as te,h as se}from"./cruds-C8awoSIz.js";import{F as oe}from"./FooterForms-D8IvpDVX.js";import{u as ie}from"./updatesSingleRow-BjGTgUib.js";import{u as ne}from"./fieldsChange-uPUKat4f.js";import{u as de}from"./DataContext-BJsy23hk.js";import{u as ce}from"./useModalState-DqEB_XcK.js";import{C as le}from"./ContactsModal-DPeQm4cf.js";import{u as ue}from"./ModalsContext-CDMOE33t.js";class p extends Error{constructor(r,s){super(s);R(this,"step");this.name="ProjectCreationError",this.step=r}}function pe(a,e){var s;if(!a)throw new p("Validación","No hay una cotización seleccionada");if(!e)throw new p("Validación","No se seleccionó ninguna oportunidad");const r=(s=e.quotes)==null?void 0:s.find(d=>d.id===a);if(!r)throw new p("Validación","No se encontró la cotización seleccionada");return r}function me(a,e){var s;const r=(s=a.name)==null?void 0:s.trim();if(!r)throw new p("Validación","El nombre del proyecto es obligatorio");return{name:r,id_opportunity:a.id,id_quote:e.id,id_client:a.id_client,scope:a.scope||"",method_payment:e.method_payment,guarantee:e.guarantee,materials:e.materials,labor:e.labor,subcontracting:e.subcontracting,others:e.others,general:e.general}}async function fe(a,e){const{data:r,error:s}=await re.insertOne(a);if(s||!r||!("id"in r))throw new p("Creación de proyecto","Error al crear proyecto");const d=r.id,{error:c}=await P.update({id:e.id,values:{id_project:d}});if(c)throw new p("Actualización de oportunidad","Error al actualizar oportunidad");return d}async function he(a,e,r,s){const d=new Set([...e,...r].map(t=>t.id_phase)),c=a.filter(t=>d.has(t.id));if(c.length===0)throw new p("Creación de fases","Cantidad de fases creadas no coincide");const h=c.map(t=>{var f;return{name:(f=t.name)==null?void 0:f.trim(),id_project:s}}),{data:o,error:b}=await ae.insert(h);if(b||!o||o.length!==c.length)throw new p("Creación de fases","Error al crear fases");return c.reduce((t,f,m)=>(t[f.id]=o[m].id,t),{})}async function ge(a,e,r){if(a.length===0)return;const s=a.map(({id:c,created_at:h,...o})=>({...o,id_phase:e[o.id_phase],id_project:r})),{error:d}=await te.insert(s);if(d)throw new p("Presupuesto - Ítems","Error al crear ítems del presupuesto")}async function we(a,e,r){if(a.length===0)return;const s=a.map(({id:c,created_at:h,materials:o,prices:b,...t})=>({...t,id_phase:e[t.id_phase],id_project:r})),{error:d}=await se.insert(s);if(d)throw new p("Presupuesto - Materiales","Error al crear materiales del presupuesto")}function Fe({defaultValues:a,isNew:e,selectedQuoteId:r,initialEditMode:s}){var O,M,I,v;const d=ce(),[c,h]=F.useState(s),{openModal:o,setProgressiveSteps:b,updateStep:t}=ue(),f=X(),{selectedClient:m,editByStatus:E}=ee(),{selectedOpportunity:_,getOpportunities:z}=de(),{register:g,watch:S,formState:{errors:j,dirtyFields:V,isSubmitSuccessful:L,isDirty:q},setValue:T,handleSubmit:U}=D({defaultValues:a??{name:"",id_client:void 0,status:"",created_by:""}}),G=[{label:"Creando proyecto",status:"pending"},{label:"Creando fases",status:"pending"},{label:"Insertando ítems",status:"pending"},{label:"Insertando materiales",status:"pending"}];ne({isSubmitSuccessful:L,isDirty:q}),F.useEffect(()=>{m&&m.id!==S("id_client")&&T("id_client",m.id,{shouldDirty:!0})},[m]);const $=async l=>{try{if(e){o("LOADING",{title:"Guardando oportunidad",message:"Por favor, espere..."});const{data:i,error:u}=await P.insertOne(l);if(u||!i||!("id"in i))throw new Error("Error al crear oportunidad");o("SUCCESS",{title:"Oportunidad creada con éxito",message:"La oportunidad se ha creado correctamente."}),z(),f(`/opportunity/${i.id}/resumen`)}if(!e)if(o("LOADING",{title:"Actualizando oportunidad",message:"Por favor, espere..."}),await ie({dirtyFields:Object.fromEntries(Object.entries(V).filter(([i,u])=>typeof u=="boolean")),formData:l,onUpdate:P.update}),l.status==="Ganada"&&r&&_&&_.id_project===null)if(b(G),o("PROGRESSIVE"),"id"in l&&"created_at"in l){const i=await k({formData:l,selectedOpportunity:_});o("SUCCESS",{title:"✅ Proyecto creado con éxito",message:"El proyecto se ha creado correctamente.",btnPrimary:{label:"Ir al Proyecto",handleOnClick:()=>{f(`/project/${i}/resumen`)},variant:"green"}})}else throw new Error("Los datos de la oportunidad no son válidos para crear un proyecto");else o("SUCCESS",{title:"Oportunidad actualizada",message:"La oportunidad se ha actualizado correctamente."})}catch(i){o("ERROR",{title:"Error al guardar oportunidad",message:String(i)})}};async function k({formData:l,selectedOpportunity:i}){try{t(0,"done");const u=pe(r,i),w=me(l,u),y=await fe(w,l);t(1,"in-progress");const A=await he(i.phases,i.details_items,i.details_materials,y);t(1,"done"),t(2,"in-progress");const H=i.details_items.filter(x=>x.id_quote===r);await ge(H,A,y),t(2,"done"),t(3,"in-progress");const J=i.details_materials.filter(x=>x.id_quote===r);return await we(J,A,y),t(3,"done"),y}catch(u){let w="Ocurrió un error desconocido";return u instanceof p?w=`Error en ${u.step}: ${u.message}`:u instanceof Error&&(w=`Error inesperado: ${u.message}`),o("ERROR",{title:"Error al crear el proyecto",message:w}),null}}const B=S("status")==="Perdida";return n.jsxs(n.Fragment,{children:[n.jsxs("form",{className:" flex flex-col gap-6",onSubmit:U($),children:[n.jsx("fieldset",{disabled:!c,children:n.jsx(Q,{title:"Datos de la Oportunidad",children:n.jsxs("div",{className:"flex flex-col gap-4",children:[n.jsx(C,{label:"Nombre de Oportunidad",placeholder:"Ingresa un nombre para la oportunidad",disabled:!E&&!c,...g("name",{required:"Campo requerido"}),error:(O=j.name)==null?void 0:O.message}),n.jsx(C,{label:"Cliente",placeholder:"Seleccione un cliente",readOnly:!0,disabled:!E&&!c,value:(m==null?void 0:m.nombre)||"",onClick:()=>{d.openModal()},error:(M=j.id_client)==null?void 0:M.message}),n.jsx(C,{type:"hidden",...g("id_client",{required:!0,valueAsNumber:!0})}),n.jsx(N,{disabled:!E&&!c,label:"Alcance",...g("scope")}),n.jsx(Y,{label:"Status",selectText:"Selecciona un status",defaultValue:"Nuevo",...g("status",{required:!0}),error:(I=j.status)==null?void 0:I.message,children:n.jsx(Z,{})}),n.jsx(N,{disabled:S("status")!=="Perdida",label:"Razón de pérdida",...g("loss_reason",{required:{value:B,message:"Campo requerido"}}),error:(v=j.loss_reason)==null?void 0:v.message})]})})}),n.jsx(oe,{isNew:e,isEditMode:c,onToggleEdit:()=>h(l=>!l)})]}),n.jsx(le,{open:d.open,onClose:d.closeModal,type:"client"})]})}export{Fe as O};
