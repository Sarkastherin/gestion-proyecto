import{r as o,j as e}from"./chunk-PVWAREVJ-xN2wnjH-.js";import{I as x}from"./Inputs-nFJy7MmX.js";import{p as N}from"./cruds-C8awoSIz.js";import{u as H,a as L}from"./index.esm-BDlKQGcf.js";import{a as J,b as K}from"./Buttons-RpKxWaSJ.js";import{u as Q}from"./UIContext-CTPOFttf.js";import{u as W}from"./ContactsContext-CvsXE9G3.js";import{F as X}from"./FooterForms-D8IvpDVX.js";import{B as Y}from"./Buttons-BBIplumE.js";import{d as Z}from"./functions-kWnBqdLU.js";import{a as V}from"./realTime-CHJ-WwWR.js";import{u as ee}from"./updatesArraysFields-DUYxr964.js";import{C as se}from"./ContactsModal-DPeQm4cf.js";import{u as re}from"./useModalState-DqEB_XcK.js";import{u as ae}from"./ModalsContext-CDMOE33t.js";function je({defaultValues:f,idMaterial:v,modalMode:k,onSelectPrice:d}){const[I,F]=o.useState(!1);V(v);const{openModal:p}=ae(),w=re(),C=Z(new Date),{suppliers:y}=W(),[j,D]=o.useState(null),[E,S]=o.useState([]),{selectedSupplier:n,setSelectedSupplier:_}=Q(),{register:g,watch:m,formState:{errors:u,dirtyFields:M,isDirty:O},control:P,setValue:$,handleSubmit:R,reset:A}=H({defaultValues:f}),{fields:c,append:z,remove:q}=L({control:P,name:"prices"}),B=()=>{z({id_material:v??null,id_supplier:null,price:0,default:c.length===0,date:C})},U=async r=>{if(r.prices.filter(a=>a.default).length!==1&&r.prices.length>0){p("INFORMATION",{title:"Formulario inválido",message:"Debe haber al menos un precio marcado como 'default'"});return}if(!O){p("INFORMATION",{title:"Formulario sin cambios",message:"No hay cambios para actualizar'"});return}try{p("LOADING",{title:"Guardando precios",message:"Por favor, espere..."});const{prices:a}=r,t=await ee({fieldsArray:a,dirtyFields:M,fieldName:"prices",fieldsDelete:E,onUpdate:N.update,onInsert:N.insertOne,onRemove:i=>N.remove({id:i})});p("SUCCESS",{message:"Se han guardado los datos"});const l=a.filter(i=>"id"in i&&typeof i.id=="number");A({prices:[...l,...Array.isArray(t)?t:[]]}),S([])}catch{p("ERROR",{message:"Hubieron algunos problemas al intentar procesar la información"})}},T=r=>{D(r),_(null),w.openModal()};o.useEffect(()=>{if(n&&j!==null){$(`prices.${j}.id_supplier`,n.id,{shouldDirty:!0});const r=document.getElementById(`prices.${j}.name_supplier`);r&&(r.value=n.nombre)}},[n]),o.useEffect(()=>{A(f),k&&F(!0)},[]),o.useEffect(()=>{c.length>0&&c.map((r,s)=>{const a=document.getElementById(`prices.${s}.name_supplier`);if(a){const t=y==null?void 0:y.find(l=>l.id===r.id_supplier);a.value=t?t.nombre:""}})},[c]);const G=r=>{const s=f.prices[r];q(r),s&&"id"in s&&s.id!==void 0&&S(a=>[...a,s.id])};return e.jsxs(e.Fragment,{children:[e.jsxs("form",{onSubmit:R(U),className:"",children:[e.jsx("fieldset",{disabled:!I,children:e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("table",{className:"min-w-full table-auto divide-y-2 divide-zinc-200 dark:divide-zinc-700",children:[e.jsxs("colgroup",{children:[e.jsx("col",{className:"w-[1%]"}),e.jsx("col",{className:"w-[1%]"}),e.jsx("col",{className:"w-[1%]"}),e.jsx("col",{}),e.jsx("col",{className:"w-[15%]"}),e.jsx("col",{className:"w-[1%]"}),e.jsx("col",{className:"w-[1%]"}),d&&e.jsx("col",{className:"w-[1%]"})]}),e.jsx("thead",{className:"ltr:text-left rtl:text-right",children:e.jsxs("tr",{className:"*:font-medium *:text-zinc-900 dark:*:text-white",children:[e.jsx("th",{className:"px-1 py-2 whitespace-nowrap",children:"#"}),e.jsx("th",{className:"px-1 py-2 whitespace-nowrap",children:"Fecha"}),e.jsx("th",{className:"px-1 py-2 whitespace-nowrap",children:"Id Prov."}),e.jsx("th",{className:"px-1 py-2 whitespace-nowrap",children:"Proveedor"}),e.jsx("th",{className:"px-1 py-2 whitespace-nowrap",children:"Precio"}),e.jsx("th",{className:"px-1 py-2 whitespace-nowrap",children:"Default"}),e.jsx("th",{className:"px-1 py-2 whitespace-nowrap",children:"🗑️"}),d&&e.jsx("th",{className:"px-1 py-2 whitespace-nowrap",children:"Seleccionar"})]})}),e.jsx("tbody",{className:"divide-y divide-zinc-200 dark:divide-zinc-700",children:c.map((r,s)=>{var a,t,l,i;return e.jsxs("tr",{className:"*:text-zinc-900 *:first:font-medium dark:*:text-white",children:[e.jsx("td",{className:"px-1 py-2 whitespace-nowrap",children:s+1}),e.jsx("td",{className:"px-1 py-2 whitespace-nowrap",children:e.jsx(x,{placeholder:"Fecha",type:"date",...g(`prices.${s}.date`,{required:"Campo requerido"}),error:u.prices&&((t=(a=u.prices[s])==null?void 0:a.date)==null?void 0:t.message)})}),e.jsx("td",{className:"px-1 py-2 whitespace-nowrap",children:e.jsx(x,{placeholder:"ID",...g(`prices.${s}.id_supplier`,{required:"Campo requerido"}),readOnly:!0,error:u.prices&&((i=(l=u.prices[s])==null?void 0:l.id_supplier)==null?void 0:i.message)})}),e.jsx("td",{className:"px-1 py-2 whitespace-nowrap",children:e.jsx(x,{id:`prices.${s}.name_supplier`,placeholder:"Proveedor",onClick:()=>T(s),readOnly:!0})}),e.jsx("td",{className:"px-1 py-2 whitespace-nowrap",children:e.jsx(x,{placeholder:"$ 0.00",...g(`prices.${s}.price`,{required:"Campo requerido"})})}),e.jsx("td",{className:"px-1 py-2 whitespace-nowrap",children:e.jsxs("label",{htmlFor:`prices.${s}.default`,className:"relative block h-8 w-14 rounded-full bg-gray-300 transition-colors [-webkit-tap-highlight-color:_transparent] has-checked:bg-blue-500 dark:bg-gray-600 dark:has-checked:bg-blue-600",children:[e.jsx("input",{type:"checkbox",id:`prices.${s}.default`,className:"peer sr-only",checked:m(`prices.${s}.default`),onChange:()=>{c.forEach((b,h)=>{$(`prices.${h}.default`,h===s,{shouldDirty:!0})})}}),e.jsx("span",{className:"absolute inset-y-0 start-0 m-1 size-6 rounded-full bg-gray-300 ring-[6px] ring-white transition-all ring-inset peer-checked:start-8 peer-checked:w-2 peer-checked:bg-white peer-checked:ring-transparent dark:bg-gray-600 dark:ring-gray-900 dark:peer-checked:bg-gray-900"})]})}),e.jsx("td",{className:"px-1 py-2 whitespace-nowrap",children:e.jsx(J,{onClick:()=>G(s)})}),d&&e.jsx("td",{className:"px-1 py-2 whitespace-nowrap text-center",children:e.jsx("button",{type:"button",className:"text-xs dark:bg-blue-300 rounded-full px-2 py-1 text-blue-600 dark:text-blue-700 font-bold disabled:opacity-50 cursor-pointer disabled:cursor-not-allowed",disabled:!m(`prices.${s}.id`),onClick:()=>{const b=Number(m(`prices.${s}.id`)),h=m(`prices.${s}`);b>0&&d({id:b,price:h})},children:"Usar"})})]},r.id??s)})})]}),e.jsx("div",{className:"mt-4",children:e.jsx(K,{"aria-label":"Agregar nuevo precio",onClick:B})})]})}),k?e.jsx("div",{className:"mt-4 float-end w-32",children:e.jsx(Y,{type:"submit",variant:"yellow",children:"Guardar"})}):e.jsx(X,{isNew:!1,isEditMode:I,onToggleEdit:()=>F(r=>!r)})]}),e.jsx(se,{open:w.open,onClose:w.closeModal,type:"supplier"})]})}export{je as P};
