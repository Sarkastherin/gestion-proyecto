import{r as p,j as a,w as ie,a as le}from"./chunk-PVWAREVJ-xN2wnjH-.js";import{u as oe,a as ne}from"./index.esm-BDlKQGcf.js";import{i as F}from"./cruds-C8awoSIz.js";import{u as ce}from"./UIContext-CTPOFttf.js";import{F as de}from"./FooterForms-D8IvpDVX.js";import{T as me,C as u}from"./TableDetailsQuotes-D5JfbwjB.js";import{I as j}from"./Inputs-nFJy7MmX.js";import{a as ue,b as pe}from"./Buttons-RpKxWaSJ.js";import{u as fe}from"./updatesArraysFields-DUYxr964.js";import{r as he}from"./functions-kWnBqdLU.js";import{S as be}from"./SelectUnits-CSP1Zv-A.js";import{u as xe}from"./fieldsChange-uPUKat4f.js";import{u as U}from"./DataContext-BJsy23hk.js";import{M as B}from"./ModalBase-Cfo712yZ.js";import{c as Ce}from"./materials-CC33fEpt.js";import{E as je}from"./EntityTable-BPgGIcNJ.js";import{u as z}from"./useModalState-DqEB_XcK.js";import{P as ye}from"./PricesForm-MPDyXJwJ.js";import{u as Me}from"./ModalsContext-CDMOE33t.js";import"./ContactsContext-CvsXE9G3.js";import"./Buttons-BBIplumE.js";import"./Link-DPrQ_H2S.js";import"./TrashIcon-B0Rn98mB.js";import"./FooterUITable-CqXDuJus.js";import"./Containers-PvQTCG8J.js";import"./realTime-CHJ-WwWR.js";import"./ContactsModal-DPeQm4cf.js";function ge({open:S,onClose:c,activeIndex:f,onSelectMaterial:n}){const[l,d]=p.useState([]),{getMaterials:y,materials:h}=U(),v=b=>{f!==null&&(n(f,b),c())};return p.useEffect(()=>{h||y()},[]),p.useEffect(()=>{h&&d(h)},[h]),a.jsx(B,{title:"Listado de Materiales",open:S,zIndex:40,onClose:c,width:"max-w-4xl",footer:{btnSecondary:{label:"Cancelar",handleOnClick:c}},children:a.jsx("div",{className:"px-6 pt-6 overflow-y-auto",style:{maxHeight:"calc(100vh - 270px)"},children:a.jsx(je,{columns:Ce,data:l,onRowClick:v,filterFields:[{key:"description",label:"Buscar por descripción"}]})})})}function Se({open:S,onClose:c,onSelectPrice:f,prices:n,idMaterial:l}){return a.jsx(B,{title:`Listado de Precios ${l?`- ID: ${l}`:""}`,open:S,zIndex:40,onClose:c,width:"max-w-4xl",children:a.jsx("div",{className:"px-6 pt-6 overflow-y-auto",style:{maxHeight:"calc(100vh - 270px)"},children:n&&l&&a.jsx(ye,{defaultValues:{prices:n},idMaterial:l,modalMode:!0,onSelectPrice:f})})})}function Xe({}){return[{title:"Oportunidad [Cotización]"},{name:"description",content:"Oportunidad [Cotización]"}]}const Ye=ie(function(){var k,q;const[c,f]=p.useState(!1),{openModal:n}=Me(),l=z(),d=z(),{selectedQuoteId:y}=le(),[h,v]=p.useState([]),[b,O]=p.useState(null),{selectedPhase:M,editByStatus:x}=ce(),{selectedOpportunity:L,materials:$}=U(),{register:I,formState:{isSubmitSuccessful:V,isDirty:E,dirtyFields:H,errors:_},handleSubmit:Q,control:G,watch:m,setValue:C,reset:A}=oe({defaultValues:{materials:[]}}),{fields:J,append:K,remove:W}=ne({control:G,name:"materials"}),X=async e=>{if(!E){n("INFORMATION",{title:"Formulario sin cambios",message:"No hay cambios para actualizar'"});return}n("LOADING");try{const{materials:t}=e,s=t.map(({materials:o,prices:D,...w})=>w),r=await fe({fieldName:"materials",fieldsArray:s,dirtyFields:H,fieldsDelete:h,onInsert:F.insertOne,onRemove:o=>F.remove({id:o}),onUpdate:F.update}),i=s.filter(o=>"id"in o&&typeof o.id=="number");A({materials:[...i,...Array.isArray(r)?r:[]]}),v([]),n("SUCCESS",{message:"Se han guardado los datos"})}catch(t){n("ERROR",{message:`No se pudo actualizar la oportunidad. Error: ${String(t)}`})}},Y=()=>{M&&M>0&&K({id_quote:y,id_phase:M,type:"materiales",id_material:0,quantity:0,id_price:0,notes:"",observations:""})},Z=e=>{const s=m("materials")[e];s&&"id"in s&&s.id!==void 0&&v(r=>[...r,s.id]),W(e)},{details_materials:N}=L||{};p.useEffect(()=>{const e=N==null?void 0:N.filter(t=>t.id_quote===y);e&&A({materials:e})},[N,y]);const ee=[{groupColsClass:"w-[1%]",label:"#"},{groupColsClass:"",label:"Elemento cotizado"},{groupColsClass:"w-[10%]",label:"Unidad"},{groupColsClass:"w-[10%]",label:"Cantidad"},{groupColsClass:"w-[10%]",label:"Costo unitario"},{groupColsClass:"w-[10%]",label:"Total"},{groupColsClass:"w-[1%]",label:"🗑️"}];xe({isSubmitSuccessful:V,isDirty:E});const ae=e=>{O(e);const t=m(`materials.${e}.id_material`),s=$==null?void 0:$.find(i=>i.id===t),r=(s==null?void 0:s.prices)??[];d.openModal({prices:r,idMaterial:t})},te=e=>{O(e),l.openModal()},se=(e,t)=>{const{prices:s,...r}=t,i=s.find(o=>o.default)||{};C(`materials.${e}.materials`,r),C(`materials.${e}.prices`,i),C(`materials.${e}.id_material`,r.id),C(`materials.${e}.id_price`,(i==null?void 0:i.id)||0)},re=({id:e,price:t})=>{b!==null&&(C(`materials.${b}.prices`,t,{shouldDirty:!0}),C(`materials.${b}.id_price`,e,{shouldDirty:!0}),d.closeModal())};return a.jsx(a.Fragment,{children:M&&a.jsxs(a.Fragment,{children:[a.jsxs("form",{className:" flex flex-col gap-6",onSubmit:Q(X),children:[a.jsx("fieldset",{disabled:!c,children:a.jsxs("div",{className:"overflow-x-auto",children:[a.jsx(me,{title:"Tabla Materiales",columns:ee,children:J.map((e,t)=>({...e,index:t})).filter(e=>e.id_phase===M).map(({index:e,id:t})=>{var s,r,i,o,D,w,T,P,R;return a.jsxs("tr",{className:"*:text-zinc-900 *:first:font-medium dark:*:text-white align-baseline",children:[a.jsx(u,{children:e+1}),a.jsxs(u,{children:[a.jsx(j,{disabled:!x,...I(`materials.${e}.id_material`,{required:"Campo requerido",validate:{checkNumber:g=>g>0||"No se ha seleccionado material"}}),className:"sr-only"}),a.jsx(j,{disabled:!x,readOnly:!0,placeholder:"Material",value:m(`materials.${e}.materials.description`)??"",onClick:()=>te(e),error:(i=(r=(s=_.materials)==null?void 0:s[e])==null?void 0:r.id_material)==null?void 0:i.message})]}),a.jsx(u,{children:a.jsx(be,{value:Number(m(`materials.${e}.materials.id_unit`)??0),disabled:!0})}),a.jsx(u,{children:a.jsx(j,{disabled:!x,type:"number",step:.01,...I(`materials.${e}.quantity`,{valueAsNumber:!0,required:"Campo requerido",validate:{checkNumber:g=>g>0||"No se ha seleccionado precio"}}),error:(w=(D=(o=_.materials)==null?void 0:o[e])==null?void 0:D.quantity)==null?void 0:w.message})}),a.jsxs(u,{children:[a.jsx(j,{className:"sr-only",...I(`materials.${e}.id_price`,{required:"Campo requerido",validate:{checkNumber:g=>g>0||"No se ha seleccionado precio"}})}),a.jsx(j,{disabled:!x,readOnly:!0,value:Number(m(`materials.${e}.prices.price`)??0),placeholder:"$ 0.00",onClick:()=>ae(e),error:(R=(P=(T=_.materials)==null?void 0:T[e])==null?void 0:P.id_price)==null?void 0:R.message})]}),a.jsx(u,{children:a.jsx(j,{type:"number",placeholder:"Total",readOnly:!0,value:he((m(`materials.${e}.quantity`)??0)*(m(`materials.${e}.prices.price`)??0),2)})}),a.jsx(u,{children:a.jsx(ue,{disabled:!x,onClick:()=>Z(e)})})]},t)})}),a.jsx(pe,{disabled:!x,title:"Agregar Material",onClick:Y})]})}),a.jsx(de,{isNew:!1,isEditMode:c,onToggleEdit:()=>f(e=>!e)})]}),a.jsx(ge,{activeIndex:b,onSelectMaterial:se,open:l.open,onClose:l.closeModal}),a.jsx(Se,{open:d.open,onClose:d.closeModal,onSelectPrice:re,prices:((k=d.data)==null?void 0:k.prices)??[],idMaterial:((q=d.data)==null?void 0:q.idMaterial)??0})]})})});export{Ye as default,Xe as meta};
