import{r as f,j as Dt}from"./chunk-PVWAREVJ-Cl_c9Jt0.js";import{s as y}from"./supabaseClient-O5NoNd5h.js";import{u as qt}from"./ContactsContext-BtjVusI7.js";import{g as xt,r as _,a as kt}from"./functions-CIXTKjf3.js";async function T({table:i,select:r,id_name:e}){let t=[],a=0;const u=1e3;for(;;){const{data:o,error:p}=await y.from(i).select(r).order(e||"id",{ascending:!1}).range(a,a+u-1);if(p)throw new Error(`Error al obtener datos de ${i}: ${p.message}`);if(!o||o.length===0||(t=t.concat(o),a+=u,o.length<u))break}return t}async function b({table:i,select:r,setData:e,clients:t,clientKey:a,id_name:u,employeeKey:o,employees:p}){if(t&&a){const l=await Pt({table:i,select:r,clientKey:a,clients:t});return e(l),l}else if(p&&o){const l=await vt({table:i,select:r,employeeKey:o,employees:p});return e(l),l}else{i==="holidays"&&console.log("Fetching holidays without client enrichment");const l=await T({table:i,select:r,id_name:u});return e(l),l}}async function Pt({table:i,select:r,clientKey:e,clients:t}){let a=await T({table:i,select:r});return t&&t.length>0&&e&&(a=a.map(o=>{const p=o[e],l=t.find(E=>E.id===p);return l?{...o,client:l}:null}).filter(o=>o!==null)),a}async function vt({table:i,select:r,employeeKey:e,employees:t}){let a=await T({table:i,select:r});return t&&t.length>0&&e&&(a=a.map(o=>{const p=o[e],l=t.find(E=>E.id===p);return l?{...o,employee:l}:null}).filter(o=>o!==null)),a}const c=i=>({insertOne:async r=>{try{const{data:e,error:t}=await y.from(i).insert([r]).select();if(t)throw t;return{data:(e==null?void 0:e[0])??null,error:null}}catch(e){return{data:null,error:e instanceof Error?e:new Error(typeof e=="object"&&e!==null&&"message"in e?e.message:String(e))}}},insert:async r=>{try{const{data:e,error:t}=await y.from(i).insert(r).select();if(t)throw t;return{data:e??null,error:null}}catch(e){return{data:null,error:e instanceof Error?e:new Error(typeof e=="object"&&e!==null&&"message"in e?e.message:String(e))}}},getAll:async r=>{const e=r.page??1,t=r.pageSize??100,a=(e-1)*t,u=a+t-1;try{const{data:o,error:p,count:l}=await y.from(i).select("*",{count:"exact"}).order("id",{ascending:!0}).range(a,u);if(p)throw p;return{data:o??[],error:null,count:l}}catch(o){return{data:null,error:o instanceof Error?o:new Error(typeof o=="object"&&o!==null&&"message"in o?o.message:String(o)),count:null}}},getById:async({id:r})=>{try{const{data:e,error:t}=await y.from(i).select("*").eq("id",r);if(t)throw t;return{data:(e==null?void 0:e[0])??null,error:null}}catch(e){return console.log(e),{data:null,error:e instanceof Error?e:new Error(typeof e=="object"&&e!==null&&"message"in e?e.message:String(e))}}},getDataByAnyColumn:async({column:r,id:e})=>{try{const{data:t,error:a,count:u}=await y.from(i).select("*").eq(r,e);if(a)throw a;return{data:t??[],error:null,count:u}}catch(t){return{data:null,error:t instanceof Error?t:new Error(typeof t=="object"&&t!==null&&"message"in t?t.message:String(t)),count:null}}},update:async({id:r,values:e})=>{try{const{status:t,error:a}=await y.from(i).update(e).eq("id",r);if(a)throw a;return{status:t,error:null}}catch(t){return{status:null,error:t instanceof Error?t:new Error(typeof t=="object"&&t!==null&&"message"in t?t.message:String(t))}}},remove:async({id:r})=>{try{const{status:e,error:t}=await y.from(i).delete().eq("id",r);if(t)throw t;return{status:e,error:null}}catch(e){return e.code==="23503"?{status:null,error:new Error("No se puede eliminar este registro porque estÃ¡ siendo utilizado en otra tabla.")}:{status:null,error:e instanceof Error?e:new Error(typeof e=="object"&&e!==null&&"message"in e?e.message:String(e))}}},filter:async r=>{var e;try{let t=y.from(i).select("*",{count:"exact"});if(r.searchText&&((e=r.columnsToSearch)!=null&&e.length)){const S=r.columnsToSearch.map(h=>`${h}.ilike.%${r.searchText}%`).join(",");t=t.or(S)}if(r.exactFilters)for(const[S,h]of Object.entries(r.exactFilters))h!==""&&(t=t.eq(S,h));if(r.rangeFilters)for(const[S,h]of Object.entries(r.rangeFilters))h.min!==void 0&&(t=t.gte(S,h.min)),h.max!==void 0&&(t=t.gte(S,h.max));const a=r.page??1,u=r.pageSize??10,o=(a-1)*u,p=o+u-1;t=t.range(o,p);const{data:l,error:E,count:M}=await t;if(E)throw E;return{data:l??[],error:null,count:M}}catch(t){return console.log(t),{data:null,error:t instanceof Error?t:new Error(typeof t=="object"&&t!==null&&"message"in t?t.message:String(t)),count:null}}},getDataByEveryIds:async(r,e)=>{try{const{data:t,error:a,count:u}=await y.from(i).select("*",{count:"exact"}).in(e,r);if(a)throw a;return{data:t??[],error:null,count:u}}catch(t){return{data:null,error:t instanceof Error?t:new Error(typeof t=="object"&&t!==null&&"message"in t?t.message:String(t)),count:null}}}}),Rt=c("opportunities"),Ft=c("phases"),zt=c("quotes"),Qt=c("details_items"),Nt=c("details_materials"),$t=c("prices"),Ht=c("materials"),Ut=c("families"),Vt=c("categories"),Wt=c("subcategories"),Gt=c("units"),Jt=c("projects"),Lt=c("phases_project"),Xt=c("budget_details_items"),Yt=c("budget_details_materials"),Zt=c("tasks"),Kt=c("task_assignments"),te=c("daily_reports"),ee=c("report_tasks"),re=c("report_employees"),Ot=c("holidays"),tt=f.createContext(void 0),se=({children:i})=>{const{clients:r,employees:e}=qt(),[t,a]=f.useState(null),[u,o]=f.useState(null),[p,l]=f.useState(null),[E,M]=f.useState(null),[S,h]=f.useState(null),[et,rt]=f.useState(null),[st,ot]=f.useState(null),[B,R]=f.useState(null),[I,at]=f.useState(null),[F,z]=f.useState(null),[nt,Q]=f.useState(null),[it,ct]=f.useState(null),[lt,ut]=f.useState(null),dt=async()=>{r&&b({table:"projects",select:"*, users(*), phases_project_supervisors:phases_project(id_supervisor)",clientKey:"id_client",clients:r,setData:a})},pt=async()=>{r&&b({table:"opportunities",select:"*, users(*)",clientKey:"id_client",clients:r,setData:o})},N=async()=>b({table:"materials",select:"*, prices(*), view_categorizations(*), units(*)",setData:ot}),gt=async()=>b({table:"units",select:"*",setData:l}),mt=async()=>b({table:"families",select:"*",setData:M}),ft=async()=>b({table:"categories",select:"*",setData:h}),yt=async()=>b({table:"subcategories",select:"*",setData:rt}),$=async(d,n)=>{try{const{data:s,error:g}=await y.from("opportunities").select("*, phases(*), quotes(*)").eq("id",d).single();if(g||!s)throw new Error("No se pudo obtener la oportunidad");const P=r==null?void 0:r.find(A=>A.id===s.id_client);if(!P)throw new Error("Cliente no encontrado");const j=Array.isArray(s.quotes)&&s.quotes.length>0;let D={details_items:[],details_materials:[]};if(j){const A=s.quotes.map(v=>v.id),{data:w,error:x}=await y.from("quotes").select("details_items(*), details_materials(*,materials:id_material(*),prices:id_price(*))").in("id",A);if(x)throw new Error(`Error al obtener detalles de quotes: ${x.message}`);if(w!=null&&w.length){const O=s.quotes.map(m=>{const C=w.find(Y=>{var Z,K;return(((Z=Y.details_items[0])==null?void 0:Z.id_quote)??((K=Y.details_materials[0])==null?void 0:K.id_quote))===m.id});if(!C)return m;const k=kt(C),W=_(k.total_materials*((m.materials??0)/100+1),2),G=_(k.total_labor*((m.labor??0)/100+1),2),J=_(k.total_subcontracting*((m.subcontracting??0)/100+1),2),L=_(k.total_others*((m.others??0)/100+1),2),X=_(W+G+J+L,2),At=_(X*((m.general??0)/100+1),2);return{...m,...k,t_mg_materials:W,t_mg_labor:G,t_mg_subcontracting:J,t_mg_others:L,total:X,t_mg_total:At}});s.quotes=O,D={details_items:w.flatMap(m=>m.details_items??[]),details_materials:w.flatMap(m=>m.details_materials??[])}}}const q={...s,client:P,...D};return n||R(q),q}catch(s){return console.error("Error en getOpportunityById:",s),null}},H=async(d,n)=>{try{const{data:s,error:g}=await y.from("projects").select("*, phases_project(*, tasks:view_task_and_progress(*, task_assignments(*)), daily_reports(*, report_tasks(*), report_employees(*))), budget_details_items(*), budget_details_materials(*,materials:id_material(*),prices:id_price(*))").eq("id",d).single();if(g||!s)throw new Error("No se pudo obtener el proyecto");const P={details_items:s.budget_details_items??[],details_materials:s.budget_details_materials??[]},j=xt(P),D=_(j.total_materials*((s.materials??0)/100+1),2),q=_(j.total_labor*((s.labor??0)/100+1),2),A=_(j.total_subcontracting*((s.subcontracting??0)/100+1),2),w=_(j.total_others*((s.others??0)/100+1),2),x=_(D+q+A+w,2),v=_(x*((s.general??0)/100+1),2),O=r==null?void 0:r.find(C=>C.id===s.id_client);if(!O)throw new Error("Cliente no encontrado");const m={...s,...j,t_mg_materials:D,t_mg_labor:q,t_mg_subcontracting:A,t_mg_others:w,total:x,t_mg_total:v,client:O};return at(m),m}catch(s){return console.error("Error en getProjectById:",s),null}},U=(d,n)=>{const s=n.find(g=>g.id===d);z(s||null)},_t=async()=>{if(!B)return;const{id:d}=B,n=await $(d);n&&o(s=>(s==null?void 0:s.map(g=>g.id===n.id?n:g))??[])},ht=async d=>{const{id:n}=F||{},s=n||d;if(!s)return;const g=await N();!g||g.length===0||U(s,g)},wt=async()=>{if(!I)return;const{id:d}=I,n=await H(d);n&&a(s=>(s==null?void 0:s.map(g=>g.id===n.id?n:g))??[])},bt=async()=>b({table:"view_report_employees",select:"*",employeeKey:"id_employee",employees:e||[],setData:Q}),Et=async d=>{const{data:n,error:s}=await y.from("view_daily_reports").select("*").eq("id_supervisor",d);if(s)throw new Error("No se pudieron obtener los partes diarios");return ct(n),n},St=async d=>{const{data:n,error:s}=await y.from("daily_reports").select("*, report_tasks(*), report_employees(*)").eq("id",d).single();if(s||!n)throw new Error("No se pudo obtener el parte diario");return n},V=async()=>b({table:"holidays",select:"*",setData:ut}),jt=async d=>{try{const{error:n}=await Ot.remove({id:d});if(n)throw n;await V()}catch(n){throw console.error("Error deleting holiday:",n),n}};return Dt.jsx(tt.Provider,{value:{getProjects:dt,projects:t,getOpportunities:pt,opportunities:u,getMaterials:N,materials:st,getOpportunityById:$,selectedOpportunity:B,refreshOpportunity:_t,setSelectedOpportunity:R,refreshMaterial:ht,getMaterial:U,getUnits:gt,units:p,getFamilies:mt,families:E,getCategories:ft,categories:S,getSubcategories:yt,subcategories:et,selectedMaterial:F,setSelectedMaterial:z,getProjectById:H,selectedProject:I,refreshProject:wt,getReportsEmployees:bt,reportsEmployees:nt,setReportsEmployees:Q,getReportsBySupervisor:Et,dailyReportsView:it,getDailyReportById:St,getHolidays:V,holidays:lt,deleteHoliday:jt},children:i})},oe=()=>{const i=f.useContext(tt);if(i===void 0)throw new Error("useData must be used within a DataProvider");return i};export{se as D,Nt as a,Xt as b,Yt as c,Qt as d,Ft as e,Jt as f,Lt as g,Gt as h,Ut as i,Vt as j,Wt as k,re as l,Ht as m,te as n,Rt as o,$t as p,zt as q,ee as r,b as s,Zt as t,oe as u,Kt as v,Ot as w};
