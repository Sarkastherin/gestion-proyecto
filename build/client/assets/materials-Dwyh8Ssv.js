import{w as ae,r as j,a as te,j as a}from"./chunk-PVWAREVJ-Cl_c9Jt0.js";import{u as re,a as se}from"./index.esm-CLpX3RIH.js";import{u as ie,a as _}from"./DataContext-BHROWMOn.js";import{u as oe,a as le}from"./UIContext-9PjeG9pu.js";import{F as me}from"./FooterForms-CbBXM1X1.js";import{T as ne,C as n}from"./TableDetailsQuotes-BoXQZsCR.js";import{I as u}from"./Inputs-cvlDeTHR.js";import{b as ce,c as de}from"./Buttons-ByA9cNaT.js";import{u as pe}from"./updatesArraysFields-CDmdxi8j.js";import{r as ue}from"./functions-CIXTKjf3.js";import{S as fe}from"./SelectUnits-CAeHjHA-.js";import{u as he}from"./fieldsChange-DvNB-iS-.js";import{M as Me,P as be}from"./PriceModal-omb6x32Q.js";import{u as k}from"./useModalState-Dynfoma4.js";import{c as ye}from"./QuotesAndBudgetLayout-B1iVPJEX.js";import"./supabaseClient-O5NoNd5h.js";import"./ContactsContext-BtjVusI7.js";import"./Buttons-DjYWmDVV.js";import"./IconComponent-CkWBZZXK.js";import"./Link-DZjWQWvu.js";import"./TrashIcon-CpHN25SK.js";import"./ModalBase-Czr0Q5I6.js";import"./home-DOLg13rX.js";import"./EntityTable-DKwDIY9O.js";import"./FooterUITable-C66h8R_K.js";import"./Containers-ZXGJ7diH.js";import"./arrow-left-3CO6tBoR.js";import"./ProtectedRoute-DTKDj7Jz.js";import"./AuthContext-DiXfFtBN.js";import"./allowedRoles-wIcqt93s.js";import"./LoaderComponent-DzoOhiNN.js";import"./box-BumqmFUH.js";import"./PricesForm-tkTEGPJG.js";import"./realTime-Csd-v9-x.js";import"./ContactsModal-DD1Z3kEL.js";function aa({}){return[{title:"Oportunidad [Cotización]"},{name:"description",content:"Oportunidad [Cotización]"}]}const ta=ae(function(){var D,F;const[I,w]=j.useState(!1),{openModal:h}=oe(),S=k(),c=k(),{selectedQuoteId:N}=te(),[R,O]=j.useState([]),[M,x]=j.useState(null),{propsQuoteAndBudget:l,editByStatus:d}=le(),{selectedOpportunity:z,materials:C}=ie(),{register:$,formState:{isSubmitSuccessful:U,isDirty:q,dirtyFields:B,errors:g},handleSubmit:Q,control:V,watch:m,setValue:p,reset:A}=re({defaultValues:{materials:[]}}),{fields:G,append:L,remove:H}=se({control:V,name:"materials"}),J=()=>{l&&l.selsectedPhase>0&&L({id_quote:N,id_phase:l.selsectedPhase,type:"materiales",id_material:0,quantity:0,id_price:0,notes:"",observations:""})},K=e=>{const r=m("materials")[e];r&&"id"in r&&r.id!==void 0&&O(s=>[...s,r.id]),H(e)},{details_materials:b}=z||{};j.useEffect(()=>{const e=b==null?void 0:b.filter(t=>t.id_quote===N);e&&A({materials:e})},[b,N]),he({isSubmitSuccessful:U,isDirty:q});const W=e=>{x(e);const t=m(`materials.${e}.id_material`),r=C==null?void 0:C.find(i=>i.id===t),s=(r==null?void 0:r.prices)??[];c.openModal({prices:s,idMaterial:t})},X=e=>{x(e),S.openModal()},Y=(e,t)=>{const{prices:r,...s}=t,i=r.find(o=>o.default)||{};p(`materials.${e}.materials`,s),p(`materials.${e}.prices`,i),p(`materials.${e}.id_material`,s.id),p(`materials.${e}.id_price`,(i==null?void 0:i.id)||0)},Z=({id:e,price:t})=>{M!==null&&(p(`materials.${M}.prices`,t,{shouldDirty:!0}),p(`materials.${M}.id_price`,e,{shouldDirty:!0}),c.closeModal())},ee=async e=>{if(!q){h("INFORMATION",{title:"Formulario sin cambios",message:"No hay cambios para actualizar'"});return}h("LOADING");try{const{materials:t}=e,r=t.map(({materials:o,prices:v,...y})=>y),s=await pe({fieldName:"materials",fieldsArray:r,dirtyFields:B,fieldsDelete:R,onInsert:_.insertOne,onRemove:o=>_.remove({id:o}),onUpdate:_.update}),i=r.filter(o=>"id"in o&&typeof o.id=="number");A({materials:[...i,...Array.isArray(s)?s:[]]}),O([]),h("SUCCESS",{message:"Se han guardado los datos"})}catch(t){h("ERROR",{message:`No se pudo actualizar la oportunidad. Error: ${String(t)}`})}};return a.jsx(a.Fragment,{children:(l==null?void 0:l.selsectedPhase)&&a.jsxs(a.Fragment,{children:[a.jsx(ne,{title:"Tabla Materiales",columns:ye,handleSubmit:Q(ee),isEditMode:I,addElement:a.jsx(de,{disabled:!d,title:"Agregar Material",onClick:J}),footerElement:a.jsx(me,{isNew:!1,isEditMode:I,onToggleEdit:()=>w(e=>!e)}),children:G.map((e,t)=>({...e,index:t})).filter(e=>e.id_phase===l.selsectedPhase).map(({index:e,id:t})=>{var r,s,i,o,v,y,E,P,T;return a.jsxs("tr",{className:"*:text-zinc-900 *:first:font-medium dark:*:text-white align-baseline",children:[a.jsx(n,{children:e+1}),a.jsxs(n,{children:[a.jsx(u,{disabled:!d,...$(`materials.${e}.id_material`,{required:"Campo requerido",validate:{checkNumber:f=>f>0||"No se ha seleccionado material"}}),className:"sr-only"}),a.jsx(u,{disabled:!d,readOnly:!0,placeholder:"Material",value:m(`materials.${e}.materials.description`)??"",onClick:()=>X(e),error:(i=(s=(r=g.materials)==null?void 0:r[e])==null?void 0:s.id_material)==null?void 0:i.message})]}),a.jsx(n,{children:a.jsx(fe,{value:Number(m(`materials.${e}.materials.id_unit`)??0),disabled:!0})}),a.jsx(n,{children:a.jsx(u,{disabled:!d,type:"number",step:.01,...$(`materials.${e}.quantity`,{valueAsNumber:!0,required:"Campo requerido",validate:{checkNumber:f=>f>0||"No se ha seleccionado precio"}}),error:(y=(v=(o=g.materials)==null?void 0:o[e])==null?void 0:v.quantity)==null?void 0:y.message})}),a.jsxs(n,{children:[a.jsx(u,{className:"sr-only",...$(`materials.${e}.id_price`,{required:"Campo requerido",validate:{checkNumber:f=>f>0||"No se ha seleccionado precio"}})}),a.jsx(u,{disabled:!d,readOnly:!0,value:Number(m(`materials.${e}.prices.price`)??0),placeholder:"$ 0.00",onClick:()=>W(e),error:(T=(P=(E=g.materials)==null?void 0:E[e])==null?void 0:P.id_price)==null?void 0:T.message})]}),a.jsx(n,{children:a.jsx(u,{type:"number",placeholder:"Total",readOnly:!0,value:ue((m(`materials.${e}.quantity`)??0)*(m(`materials.${e}.prices.price`)??0),2)})}),a.jsx(n,{children:a.jsx(ce,{disabled:!d,onClick:()=>K(e)})})]},t)})}),a.jsx(Me,{activeIndex:M,onSelectMaterial:Y,open:S.open,onClose:S.closeModal}),a.jsx(be,{open:c.open,onClose:c.closeModal,onSelectPrice:Z,prices:((D=c.data)==null?void 0:D.prices)??[],idMaterial:((F=c.data)==null?void 0:F.idMaterial)??0})]})})});export{ta as default,aa as meta};
