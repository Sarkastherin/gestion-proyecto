import{r as f,j as kt}from"./chunk-PVWAREVJ-Cl_c9Jt0.js";import{s as y}from"./supabaseClient-O5NoNd5h.js";import{u as Tt}from"./ContactsContext-BtjVusI7.js";import{g as vt,r as h,a as Pt}from"./functions-llu_GUtd.js";async function F({table:a,select:r,id_name:e}){let t=[],n=0;const c=1e3;for(;;){const{data:o,error:l}=await y.from(a).select(r).order(e||"id",{ascending:!1}).range(n,n+c-1);if(l)throw new Error(`Error al obtener datos de ${a}: ${l.message}`);if(!o||o.length===0||(t=t.concat(o),n+=c,o.length<c))break}return t}async function S({table:a,select:r,setData:e,clients:t,clientKey:n,id_name:c,employeeKey:o,employees:l}){if(t&&n){const u=await xt({table:a,select:r,clientKey:n,clients:t});return e(u),u}else if(l&&o){const u=await Ot({table:a,select:r,employeeKey:o,employees:l});return e(u),u}else{a==="holidays"&&console.log("Fetching holidays without client enrichment");const u=await F({table:a,select:r,id_name:c});return e(u),u}}async function xt({table:a,select:r,clientKey:e,clients:t}){let n=await F({table:a,select:r});return t&&t.length>0&&e&&(n=n.map(o=>{const l=o[e],u=t.find(_=>_.id===l);return u?{...o,client:u}:null}).filter(o=>o!==null)),n}async function Ot({table:a,select:r,employeeKey:e,employees:t}){let n=await F({table:a,select:r});return t&&t.length>0&&e&&(n=n.map(o=>{const l=o[e],u=t.find(_=>_.id===l);return u?{...o,employee:u}:null}).filter(o=>o!==null)),n}const p=a=>({insertOne:async r=>{try{const{data:e,error:t}=await y.from(a).insert([r]).select();if(t)throw t;return{data:(e==null?void 0:e[0])??null,error:null}}catch(e){return{data:null,error:e instanceof Error?e:new Error(typeof e=="object"&&e!==null&&"message"in e?e.message:String(e))}}},insert:async r=>{try{const{data:e,error:t}=await y.from(a).insert(r).select();if(t)throw t;return{data:e??null,error:null}}catch(e){return{data:null,error:e instanceof Error?e:new Error(typeof e=="object"&&e!==null&&"message"in e?e.message:String(e))}}},getAll:async r=>{const e=r.page??1,t=r.pageSize??100,n=(e-1)*t,c=n+t-1;try{const{data:o,error:l,count:u}=await y.from(a).select("*",{count:"exact"}).order("id",{ascending:!0}).range(n,c);if(l)throw l;return{data:o??[],error:null,count:u}}catch(o){return{data:null,error:o instanceof Error?o:new Error(typeof o=="object"&&o!==null&&"message"in o?o.message:String(o)),count:null}}},getById:async({id:r})=>{try{const{data:e,error:t}=await y.from(a).select("*").eq("id",r);if(t)throw t;return{data:(e==null?void 0:e[0])??null,error:null}}catch(e){return console.log(e),{data:null,error:e instanceof Error?e:new Error(typeof e=="object"&&e!==null&&"message"in e?e.message:String(e))}}},getDataByAnyColumn:async({column:r,id:e})=>{try{const{data:t,error:n,count:c}=await y.from(a).select("*").eq(r,e);if(n)throw n;return{data:t??[],error:null,count:c}}catch(t){return{data:null,error:t instanceof Error?t:new Error(typeof t=="object"&&t!==null&&"message"in t?t.message:String(t)),count:null}}},update:async({id:r,values:e})=>{try{const{status:t,error:n}=await y.from(a).update(e).eq("id",r);if(n)throw n;return{status:t,error:null}}catch(t){return{status:null,error:t instanceof Error?t:new Error(typeof t=="object"&&t!==null&&"message"in t?t.message:String(t))}}},remove:async({id:r})=>{try{const{status:e,error:t}=await y.from(a).delete().eq("id",r);if(t)throw t;return{status:e,error:null}}catch(e){return e.code==="23503"?{status:null,error:new Error("No se puede eliminar este registro porque está siendo utilizado en otra tabla.")}:{status:null,error:e instanceof Error?e:new Error(typeof e=="object"&&e!==null&&"message"in e?e.message:String(e))}}},filter:async r=>{var e;try{let t=y.from(a).select("*",{count:"exact"});if(r.searchText&&((e=r.columnsToSearch)!=null&&e.length)){const w=r.columnsToSearch.map(b=>`${b}.ilike.%${r.searchText}%`).join(",");t=t.or(w)}if(r.exactFilters)for(const[w,b]of Object.entries(r.exactFilters))b!==""&&(t=t.eq(w,b));if(r.rangeFilters)for(const[w,b]of Object.entries(r.rangeFilters))b.min!==void 0&&(t=t.gte(w,b.min)),b.max!==void 0&&(t=t.gte(w,b.max));const n=r.page??1,c=r.pageSize??10,o=(n-1)*c,l=o+c-1;t=t.range(o,l);const{data:u,error:_,count:H}=await t;if(_)throw _;return{data:u??[],error:null,count:H}}catch(t){return console.log(t),{data:null,error:t instanceof Error?t:new Error(typeof t=="object"&&t!==null&&"message"in t?t.message:String(t)),count:null}}},getDataByEveryIds:async(r,e)=>{try{const{data:t,error:n,count:c}=await y.from(a).select("*",{count:"exact"}).in(e,r);if(n)throw n;return{data:t??[],error:null,count:c}}catch(t){return{data:null,error:t instanceof Error?t:new Error(typeof t=="object"&&t!==null&&"message"in t?t.message:String(t)),count:null}}}}),Yt=p("opportunities"),$t=p("phases"),Lt=p("quotes"),Ut=p("details_items"),Wt=p("details_materials"),Vt=p("prices"),Gt=p("materials"),Jt=p("families"),Xt=p("categories"),Zt=p("subcategories"),Kt=p("units"),te=p("projects"),ee=p("phases_project"),re=p("budget_details_items"),se=p("budget_details_materials"),oe=p("tasks"),ae=p("task_assignments"),ne=p("daily_reports"),ie=p("report_tasks"),ce=p("report_employees"),Rt=p("holidays"),It={weekday:[{upToHours:9,factor:1},{upToHours:1/0,factor:1.5}],saturday:[{upToHours:4,factor:1},{upToHours:9,factor:1.5},{upToHours:1/0,factor:2}],sundayOrHoliday:[{upToHours:9,factor:2},{upToHours:1/0,factor:4}]};function Mt(a,r){const e=a.split("-").map(Number);if(e.length!==3)throw new Error("Fecha inválida. Se esperaba formato YYYY-MM-DD.");const t=typeof a=="string"?new Date(e[0],e[1]-1,e[2]):a,n=typeof a=="string"?a:t.toISOString().split("T")[0];if(r.some(l=>l.date===n))return"sundayOrHoliday";const o=t.getDay();return o===0?"sundayOrHoliday":o===6?"saturday":"weekday"}function Bt(a,r,e){if(a<=0)return{equivalentHours:0,dayType:null};const t=Mt(r,e),n=It[t];let c=0,o=a,l=0;for(const _ of n){if(o<=0)break;const H=_.upToHours-l,w=Math.min(o,H);c+=w*_.factor,o-=w,l=_.upToHours}return{equivalentHours:Math.round(c*100)/100,dayType:t}}const st=f.createContext(void 0),le=({children:a})=>{const{clients:r,employees:e}=Tt(),[t,n]=f.useState(null),[c,o]=f.useState(null),[l,u]=f.useState(null),[_,H]=f.useState(null),[w,b]=f.useState(null),[ot,at]=f.useState(null),[nt,it]=f.useState(null),[R,z]=f.useState(null),[I,ct]=f.useState(null),[Q,N]=f.useState(null),[M,Y]=f.useState(null),[lt,ut]=f.useState(null),[B,dt]=f.useState(null),[pt,gt]=f.useState(null),ft=async()=>{r&&S({table:"projects",select:"*, users(*), phases_project_supervisors:phases_project(id_supervisor)",clientKey:"id_client",clients:r,setData:n})},mt=async()=>{r&&S({table:"opportunities",select:"*, users(*)",clientKey:"id_client",clients:r,setData:o})},$=async()=>S({table:"materials",select:"*, prices(*), view_categorizations(*), units(*)",setData:it}),yt=async()=>S({table:"units",select:"*",setData:u}),_t=async()=>S({table:"families",select:"*",setData:H}),ht=async()=>S({table:"categories",select:"*",setData:b}),wt=async()=>S({table:"subcategories",select:"*",setData:at}),L=async(d,i)=>{try{const{data:s,error:g}=await y.from("opportunities").select("*, phases(*), quotes(*)").eq("id",d).single();if(g||!s)throw new Error("No se pudo obtener la oportunidad");const j=r==null?void 0:r.find(D=>D.id===s.id_client);if(!j)throw new Error("Cliente no encontrado");const A=Array.isArray(s.quotes)&&s.quotes.length>0;let q={details_items:[],details_materials:[]};if(A){const D=s.quotes.map(P=>P.id),{data:E,error:T}=await y.from("quotes").select("details_items(*), details_materials(*,materials:id_material(*),prices:id_price(*))").in("id",D);if(T)throw new Error(`Error al obtener detalles de quotes: ${T.message}`);if(E!=null&&E.length){const x=s.quotes.map(m=>{const O=E.find(tt=>{var et,rt;return(((et=tt.details_items[0])==null?void 0:et.id_quote)??((rt=tt.details_materials[0])==null?void 0:rt.id_quote))===m.id});if(!O)return m;const v=Pt(O),G=h(v.total_materials*((m.materials??0)/100+1),2),J=h(v.total_labor*((m.labor??0)/100+1),2),X=h(v.total_subcontracting*((m.subcontracting??0)/100+1),2),Z=h(v.total_others*((m.others??0)/100+1),2),K=h(G+J+X+Z,2),qt=h(K*((m.general??0)/100+1),2);return{...m,...v,t_mg_materials:G,t_mg_labor:J,t_mg_subcontracting:X,t_mg_others:Z,total:K,t_mg_total:qt}});s.quotes=x,q={details_items:E.flatMap(m=>m.details_items??[]),details_materials:E.flatMap(m=>m.details_materials??[])}}}const k={...s,client:j,...q};return i||z(k),k}catch(s){return console.error("Error en getOpportunityById:",s),null}},U=async(d,i)=>{try{const{data:s,error:g}=await y.from("projects").select("*, phases_project(*, tasks:view_task_and_progress(*, task_assignments(*)), daily_reports(*, report_tasks(*), report_employees(*))), budget_details_items(*), budget_details_materials(*,materials:id_material(*),prices:id_price(*))").eq("id",d).single();if(g||!s)throw new Error("No se pudo obtener el proyecto");const j={details_items:s.budget_details_items??[],details_materials:s.budget_details_materials??[]},A=vt(j),q=h(A.total_materials*((s.materials??0)/100+1),2),k=h(A.total_labor*((s.labor??0)/100+1),2),D=h(A.total_subcontracting*((s.subcontracting??0)/100+1),2),E=h(A.total_others*((s.others??0)/100+1),2),T=h(q+k+D+E,2),P=h(T*((s.general??0)/100+1),2),x=r==null?void 0:r.find(O=>O.id===s.id_client);if(!x)throw new Error("Cliente no encontrado");const m={...s,...A,t_mg_materials:q,t_mg_labor:k,t_mg_subcontracting:D,t_mg_others:E,total:T,t_mg_total:P,client:x};return ct(m),m}catch(s){return console.error("Error en getProjectById:",s),null}},W=(d,i)=>{const s=i.find(g=>g.id===d);N(s||null)},bt=async()=>{if(!R)return;const{id:d}=R,i=await L(d);i&&o(s=>(s==null?void 0:s.map(g=>g.id===i.id?i:g))??[])},Et=async d=>{const{id:i}=Q||{},s=i||d;if(!s)return;const g=await $();!g||g.length===0||W(s,g)},St=async()=>{if(!I)return;const{id:d}=I,i=await U(d);i&&n(s=>(s==null?void 0:s.map(g=>g.id===i.id?i:g))??[])},V=async()=>S({table:"view_report_employees",select:"*",employeeKey:"id_employee",employees:e||[],setData:Y}),jt=async()=>{let d=M,i=B;if(i||(i=await C()),d||(d=await V()),M&&B){const s=d.map(g=>{const j=Bt(g.hours_worked??0,g.date_report,i||[]);return{...g,equivalent_hours:j.equivalentHours,day_type:j.dayType}});gt(s)}},At=async d=>{const{data:i,error:s}=await y.from("view_daily_reports").select("*").eq("id_supervisor",d);if(s)throw new Error("No se pudieron obtener los partes diarios");return ut(i),i},Dt=async d=>{const{data:i,error:s}=await y.from("daily_reports").select("*, report_tasks(*), report_employees(*)").eq("id",d).single();if(s||!i)throw new Error("No se pudo obtener el parte diario");return i},C=async()=>S({table:"holidays",select:"*",setData:dt}),Ht=async d=>{try{const{error:i}=await Rt.remove({id:d});if(i)throw i;await C()}catch(i){throw console.error("Error deleting holiday:",i),i}};return kt.jsx(st.Provider,{value:{getProjects:ft,projects:t,getOpportunities:mt,opportunities:c,getMaterials:$,materials:nt,getOpportunityById:L,selectedOpportunity:R,refreshOpportunity:bt,setSelectedOpportunity:z,refreshMaterial:Et,getMaterial:W,getUnits:yt,units:l,getFamilies:_t,families:_,getCategories:ht,categories:w,getSubcategories:wt,subcategories:ot,selectedMaterial:Q,setSelectedMaterial:N,getProjectById:U,selectedProject:I,refreshProject:St,getReportsEmployees:V,reportsEmployees:M,setReportsEmployees:Y,getReportsBySupervisor:At,dailyReportsView:lt,getDailyReportById:Dt,getHolidays:C,holidays:B,deleteHoliday:Ht,getLiquidationReport:jt,liquidationReport:pt},children:a})},ue=()=>{const a=f.useContext(st);if(a===void 0)throw new Error("useData must be used within a DataProvider");return a};export{le as D,Wt as a,re as b,se as c,Ut as d,$t as e,te as f,ee as g,Kt as h,Jt as i,Xt as j,Zt as k,ce as l,Gt as m,ne as n,Yt as o,Vt as p,Lt as q,ie as r,S as s,oe as t,ue as u,ae as v,Rt as w};
