import{r as g,j as e}from"./chunk-PVWAREVJ-Cl_c9Jt0.js";import{M as me}from"./ModalBase-CQji_mgJ.js";import{t as be,u as ae,r as H,l as se,n as te}from"./DataContext-B4mtDhe5.js";import{u as ne,a as he}from"./index.esm-CLpX3RIH.js";import{I as Y,S as fe}from"./Inputs-cvlDeTHR.js";import{B as J}from"./Buttons-C61rKE9q.js";import{b as xe,c as ge}from"./Buttons-dijALP0_.js";import{u as ie,a as ye}from"./UIContext-9PjeG9pu.js";import{u as je}from"./updatesArraysFields-CDmdxi8j.js";import{f as ke,c as le,a as _e}from"./realTime-VCRs_Sia.js";import{r as ve}from"./index-DG_GJQZz.js";import{u as we}from"./ContactsContext-BtjVusI7.js";import{u as Ee}from"./useModalState-Dynfoma4.js";import{B as oe}from"./Badge-BNjmnaCE.js";import{E as Ne}from"./EntityTable-CYBYbV-K.js";import{u as Ie}from"./updatesSingleRow-C5gkTyzt.js";import{F as Fe}from"./ClipboardDocumentCheckIcon-C0qHNpyc.js";import{F as ze}from"./UserGroupIcon-DFLFYX-R.js";function Re({title:t,titleId:c,...a},n){return g.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:n,"aria-labelledby":c},a),t?g.createElement("title",{id:c},t):null,g.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m3.75 9v6m3-3H9m1.5-12H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z"}))}const Se=g.forwardRef(Re);function Te({reportTasks:t,id_task:c,idDailyReport:a}){return Math.max(...t.filter(l=>l.id_task===c&&l.id_daily_report<=a).map(l=>l.progress),0)}function Oe({reportTasks:t,id_task:c,idDailyReport:a,progress:n}){return t.some(l=>l.id_task===c&&l.id_daily_report>a&&l.progress>n)}function Me({reportTasks:t,id_task:c,idDailyReport:a}){return t.some(n=>n.id_task===c&&n.id_daily_report===a)}function Ae({reportTasks:t,id_task:c,idDailyReport:a}){const n=t.find(l=>l.id_task===c&&l.id_daily_report===a);return(n==null?void 0:n.progress)??0}function Pe({filteredTasks:t,reportTasks:c,idDailyReport:a}){return t.map(n=>{const l=c.find(r=>r.id_task===n.id&&r.id_daily_report===a);return l?{...l,description:n.name}:{id:0,created_at:"",id_task:n.id,description:n.name,id_daily_report:a,progress:0}}).filter(n=>Math.max(...c.filter(r=>r.id_task===n.id_task&&r.id_daily_report<=a).map(r=>r.progress),0)<100||c.some(r=>r.id_task===n.id_task&&r.id_daily_report===a))}const ce=async({task:t,selectedPhase:c})=>{const a={name:t.description,id_phase:c,duration:0,planned:!1},{data:n,error:l}=await be.insertOne(a);if(l)throw new Error(l.message);return n};function pe({message:t,children:c}){const[a,n]=g.useState(!1),[l,r]=g.useState({top:0,left:0}),E=g.useRef(null),z=()=>{if(E.current){const N=E.current.getBoundingClientRect();r({top:N.bottom+window.scrollY+6,left:N.left+window.scrollX+N.width/2}),n(!0)}},m=()=>n(!1);return e.jsxs(e.Fragment,{children:[e.jsx("span",{ref:E,className:"relative group cursor-pointer",onMouseEnter:z,onMouseLeave:m,tabIndex:0,onFocus:z,onBlur:m,children:c}),a&&ve.createPortal(e.jsx("span",{className:"mt-2 pointer-events-none fixed z-[9999] w-max min-w-[180px] rounded px-2 py-1.5 text-xs font-semibold shadow-lg border border-zinc-700 bg-zinc-900 text-white dark:bg-zinc-200 dark:text-zinc-900",style:{top:l.top,left:l.left,transform:"translateX(-50%)"},children:t}),document.body)]})}function $e({idDailyReport:t,filteredTasks:c,selectedPhase:a,onSuccess:n,type:l}){ke(),le();const[r,E]=g.useState(null),{selectedProject:z}=ae();if(!z)return null;const{phases_project:m}=z||{};if(!m)return null;const N=(m==null?void 0:m.flatMap(s=>s.daily_reports))||[],P=s=>{E(N.find(i=>i.id===s)||null)};g.useEffect(()=>{t&&P(t)},[t,m]);const x=N.filter(s=>s.id_phase===a).flatMap(s=>s.report_tasks),{openModal:v,closeModal:L}=ie(),[A,q]=g.useState([]),I=(r==null?void 0:r.status)==="finalizado";l==="edit"||(r==null||r.status);const S={reportTasks:Pe({filteredTasks:c,reportTasks:x,idDailyReport:t})},{control:U,register:T,handleSubmit:C,watch:f,reset:_,formState:{isDirty:o,dirtyFields:p}}=ne({defaultValues:S}),{fields:R,append:X,remove:K}=he({control:U,name:"reportTasks"}),F=()=>{X({id_task:0,description:"",progress:0,id_daily_report:t})},Q=s=>{const d=f("reportTasks")[s],u=r==null?void 0:r.report_tasks.find(w=>w.id_task===d.id_task&&w.id_daily_report===d.id_daily_report);u&&u.id&&q(w=>[...w,u.id]),K(s)};function G(s,i){if(!i)return{tasks:s.filter(u=>u.progress>0)};const d={tasks:[],dirtyFields:[]};return s.forEach((u,w)=>{u.progress>0&&(d.tasks.push(u),d.dirtyFields.push(i[w]))}),d}const W=async(s,i,d)=>{const{tasks:u,dirtyFields:w}=G(s,i);await Promise.all(u.map(async(j,h)=>{const k=j.id_task>0,b=w?w[h]??{}:{},Z=Object.values(b).some(O=>O);if(k&&Z){const O={id_task:j.id_task,id_daily_report:t,progress:j.progress};d.push(j.id_task);const{error:V}=await H.insertOne(O);if(V)throw new Error(V.message)}else if(!k){const O=await ce({task:j,selectedPhase:a});if(O&&"id"in O){const V={id_task:O.id,id_daily_report:t,progress:j.progress},{error:M}=await H.insertOne(V);if(M)throw new Error(M.message)}}})),q([]),v("INFORMATION",{title:"ðŸ“ Avance de actividades creado",message:e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"âœ… Las actividades han sido creadas correctamente"}),e.jsx("p",{children:"âž¡ï¸ continue con la carga de horas del personal."})]})})},re=async(s,i,d)=>{const{tasks:u,dirtyFields:w}=G(s,i);await Promise.all((w??[]).map(async(h,k)=>{if(!h)return;const b=u[k];if(!b)return;const Z=b.id_task>0,O=b.id>0,V=Object.values(h).some(M=>M);if(!Z){const M=await ce({task:b,selectedPhase:a});if(M&&"id"in M){const B={id_task:M.id,id_daily_report:t,progress:b.progress},{error:de}=await H.insertOne(B);if(de)throw new Error(de.message)}}if(!O){const M={id_task:b.id_task,id_daily_report:t,progress:b.progress},{error:B}=await H.insertOne(M);if(B)throw new Error(B.message)}if(O&&V){const M={id_task:b.id_task,id_daily_report:t,progress:b.progress};d.push(b.id_task);const{error:B}=await H.update({id:b.id,values:M});if(B)throw new Error(B.message)}}));const j=(i??[]).map((h,k)=>{if(!h||!s[k])return null;const b=s[k];if(b.progress===0||b.id_task===0)return null;const Z=r==null?void 0:r.report_tasks.find(B=>B.id_task===b.id_task&&B.id_daily_report===b.id_daily_report),O=Z?{...b,id:Z.id}:b;d.push(O.id_task);const{description:V,...M}=O;return M}).filter(h=>!!h);await je({fieldName:"reportTasks",fieldsArray:j,dirtyFields:{reportTasks:i??[]},fieldsDelete:A,onInsert:H.insertOne,onRemove:h=>H.remove({id:h}),onUpdate:H.update}),v("INFORMATION",{title:"ðŸ“ Avance de actividades actualizado",message:e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"âœ… El avance de actividades ha sido actualizado correctamente"}),e.jsx("p",{children:"âž¡ï¸ continue con las actividades."})]})})},ee=async s=>{try{const{reportTasks:i}=s;let d=[];if(l==="new"){if(!o&&A.length===0){v("CONFIRMATION",{title:"âš ï¸ Sin cambios",message:e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"No hay datos para agregar"}),e.jsx("p",{children:"Â¿Desea continuar con el proceso de carga de personal?"})]}),onConfirm:()=>{n([]),L()}});return}v("LOADING",{message:"Procesando requerimiento"});const u=p.reportTasks??[];await W(i,u,d)}else if(Object.keys(p).length>0){const u=p.reportTasks??[];await re(i,u,d)}else i.map(u=>d.push(u.id_task));n(d)}catch(i){console.error(i),v("ERROR",{message:`Error al procesar el requerimiento: ${i.message||i}`})}},y=s=>{console.error("Errors:",s),v("ERROR",{message:"Error en el formulario, verifique los datos ingresados."})};return e.jsxs("form",{onSubmit:C(ee,y),children:[e.jsxs("fieldset",{disabled:I,children:[e.jsxs("table",{className:"w-full text-sm table-auto divide-zinc-200 dark:divide-zinc-700",children:[e.jsxs("colgroup",{children:[e.jsx("col",{}),e.jsx("col",{className:"w-[14%]"}),e.jsx("col",{className:"w-[10%]"}),e.jsx("col",{className:"w-[1%]"})]}),e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"py-1 px-1 text-left",children:"DescripciÃ³n"}),e.jsx("th",{className:"py-1 px-1",children:"Avance en PD"}),e.jsx("th",{className:"py-1 px-1",children:"Nuevo avance"}),e.jsx("th",{className:"px-1 py-1",children:"ðŸ—‘ï¸"})]})}),e.jsx("tbody",{children:R.map((s,i)=>{const d=Te({reportTasks:x,id_task:s.id_task,idDailyReport:t}),u=Ae({reportTasks:x,id_task:s.id_task,idDailyReport:t}),w=Me({reportTasks:x,id_task:s.id_task,idDailyReport:t}),j=Oe({reportTasks:x,id_task:s.id_task,idDailyReport:t,progress:u}),h=[25,50,75,100].filter(k=>k>=d);return e.jsxs("tr",{className:w?"bg-green-100/70 dark:bg-green-600/20":"",children:[e.jsxs("td",{className:"relative px-1 py-0.5 whitespace-nowrap",children:[e.jsx(Y,{...T(`reportTasks.${i}.description`,{required:!0}),defaultValue:s.description,readOnly:s.id_task!==0}),w&&e.jsx("div",{className:"absolute w-full top-0 -left-2 h-full flex items-center justify-end pr-1",children:e.jsx(pe,{message:"Reportada en este parte diario",children:e.jsx("span",{className:"text-xs rounded px-1 py-0.5 bg-yellow-300",children:"ðŸ“Œ"})})})]}),e.jsx("td",{className:"px-1 py-0.5 whitespace-nowrap",children:e.jsx(Y,{disabled:!0,value:d+"%"})}),e.jsxs("td",{className:"relative px-1 py-0.5 whitespace-nowrap",children:[e.jsxs(fe,{...T(`reportTasks.${i}.progress`,{valueAsNumber:!0,validate:k=>k===0||k>=d||"El avance no puede ser menor al actual"}),defaultValue:u,disabled:j,children:[e.jsxs("option",{value:u,children:[u,"%"]}),h.filter(k=>k!==u).map(k=>e.jsxs("option",{value:k,children:[k,"%"]},k))]}),j&&e.jsx("div",{className:"absolute w-full top-0 -left-2 h-full flex items-center justify-end pr-1",children:e.jsx(pe,{message:"No editable: existe un avance posterior registrado",children:e.jsx("span",{children:"ðŸ”’"})})})]}),e.jsx("td",{className:"px-1 py-0.5 whitespace-nowrap",children:e.jsx(xe,{onClick:()=>Q(i),disabled:j})})]},s.id)})})]}),e.jsx("div",{className:"mt-4",children:e.jsx(ge,{"aria-label":"Agregar actividad no planificada",onClick:F})})]}),e.jsx("div",{className:"mt-4 float-end",children:e.jsx(J,{variant:"outlineBlue",type:"submit",size:"sm",children:"Ir a Personal"})})]})}const Ce=[{name:"Id",selector:t=>t.id,width:"80px"},{name:"Empleado",selector:t=>t.contacto_nombre,wrap:!0},{name:"Puesto",selector:t=>t.puesto||"",width:"150px"}];function Be({open:t,onClose:c,excludeIds:a=[]}){const{setSelectedEmployee:n}=ye(),{employees:l}=we(),[r,E]=g.useState([]),z=m=>{n({...m}),c()};return g.useEffect(()=>{if(l&&l.length>0){const m=l.filter(N=>!a.includes(N.id));E(m)}},[l,a]),e.jsx(me,{title:"Listado de Empleados",open:t,zIndex:40,onClose:c,width:"max-w-4xl",footer:{btnSecondary:{label:"Cancelar",handleOnClick:c}},children:e.jsx("div",{className:"px-6 pt-6 overflow-y-auto",style:{maxHeight:"calc(100vh - 270px)"},children:e.jsx(Ne,{columns:Ce,data:r,onRowClick:z,filterFields:[{key:"contacto_nombre",label:"Empleado",autoFilter:!0},{key:"puesto",label:"Puesto",autoFilter:!0}]})})})}function Le({idDailyReport:t,idsEmployees:c,type:a,onSuccess:n}){_e();const[l,r]=g.useState(null),[E,z]=g.useState(null),{selectedProject:m,getProjectById:N,getReportsEmployees:P}=ae(),{openModal:$}=ie(),x=Ee(),{employees:v}=we(),{setSelectedEmployee:L,selectedEmployee:A}=ye(),{control:q,register:I,handleSubmit:D,watch:S,reset:U,setValue:T,formState:{dirtyFields:C,errors:f}}=ne({defaultValues:{reportEmployees:[]}}),{fields:_,append:o,remove:p}=he({control:q,name:"reportEmployees"});g.useEffect(()=>{if(m!=null&&m.phases_project&&t){const s=(m.phases_project.flatMap(i=>i.daily_reports)||[]).find(i=>i.id===t)||null;r(s)}else r(null)},[m,t]);const R=g.useMemo(()=>new Map(v==null?void 0:v.map(y=>[y.id,y.contacto_nombre])),[v]);g.useEffect(()=>{if(!l){U({reportEmployees:[]},{keepDirty:!1,keepValues:!1});return}const y=l.report_employees??[],s=l.status==="finalizado",i=y.map(j=>j.id_employee)??[],d=s?i:[...c,...i],w=[...new Set(d)].map(j=>{const h=y.find(k=>k.id_employee===j);return{id:(h==null?void 0:h.id)??null,id_daily_report:t,id_employee:j,hour_start:(h==null?void 0:h.hour_start)??"",hour_end:(h==null?void 0:h.hour_end)??"",observation:(h==null?void 0:h.observation)??"",absent:(h==null?void 0:h.absent)??!1,name_employee:R.get(j)??""}});U({reportEmployees:w},{keepDirty:!1,keepValues:!1})},[l,c,R,t,U]),g.useEffect(()=>{A&&E!==null&&(T(`reportEmployees.${E}.id_employee`,A.id,{shouldDirty:!0}),T(`reportEmployees.${E}.name_employee`,A.contacto_nombre,{shouldDirty:!0}))},[A,E,T]);const X=y=>p(y),K=()=>o({id:null,id_daily_report:t,id_employee:0,hour_start:"",hour_end:"",observation:"",absent:!1,name_employee:""}),F=y=>(S("reportEmployees")??[]).map((s,i)=>i!==y?s.id_employee:null).filter(s=>s!==null&&s!==0),Q=y=>{z(y),L(null),x.openModal({excludeIds:F(y).filter(s=>s!==null)})},G=async y=>{try{const{reportEmployees:s}=y;if(a==="new"){$("LOADING",{message:"Procesando requerimiento"});const i=s.map(j=>{const{id:h,name_employee:k,...b}=j;return b}),{data:d,error:u}=await se.insert(i);if(u)throw new Error(u.message);const w=await W(t);d&&(n(),$("INFORMATION",{title:"â±ï¸ Horas cargadas",message:e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"âœ… Las horas trabajadas han sido cargadas correctamente"}),w&&e.jsxs("p",{children:["âž¡ï¸ El status del parte diario se ha actualizado a ",e.jsx(oe,{variant:"green",children:"Finalizado"})]})]})}))}else{if(Object.keys(C).length>0){const i=s.map(u=>{const{id:w,name_employee:j,...h}=u;return w===null?h:{id:w,...h}});await je({fieldName:"reportEmployees",dirtyFields:C,fieldsArray:i,fieldsDelete:[],onInsert:se.insertOne,onRemove:u=>se.remove({id:u}),onUpdate:se.update});const d=await W(t);$("INFORMATION",{title:"â±ï¸ Horas actualizadas",message:e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"âœ… Las horas trabajadas han sido actualizadas correctamente"}),d&&e.jsxs("p",{children:["âž¡ï¸ El status del parte diario se ha actualizado a ",e.jsx(oe,{variant:"green",children:"Finalizado"})]})]})})}else await W(t)&&$("INFORMATION",{title:"Parte diario Actualizado",message:e.jsxs("p",{children:["âž¡ï¸ El status del parte diario se ha actualizado a ",e.jsx(oe,{variant:"green",children:"Finalizado"})]})});n()}}catch{$("ERROR",{message:"Error al procesar el requerimiento"})}},W=async y=>{if(!m)return;const s=await N(m.id),i=s==null?void 0:s.phases_project.flatMap(h=>h.daily_reports),d=i==null?void 0:i.find(h=>h.id===t),u=!!(d!=null&&d.report_tasks&&d.report_tasks.length>0),w=!!(d!=null&&d.report_employees&&d.report_employees.length>0);if(!u||!w||(d==null?void 0:d.status)==="finalizado")return;const{error:j}=await te.update({id:y,values:{status:"finalizado"}});if(j)throw new Error("Problemas al actualizar el status del reporte:",{cause:j});return!0},re=y=>{console.log("FORM ERRORS",y)};if(!(m!=null&&m.phases_project))return e.jsx("p",{className:"text-center py-4",children:"Cargando proyecto..."});if(!l)return e.jsx("p",{className:"text-center py-4",children:"Cargando parte diario..."});const ee=l.status==="finalizado";return e.jsxs(e.Fragment,{children:[e.jsxs("form",{onSubmit:D(G,re),children:[e.jsxs("fieldset",{disabled:ee,children:[e.jsxs("table",{className:"w-full text-sm table-auto divide-zinc-200 dark:divide-zinc-700",children:[e.jsxs("colgroup",{children:[e.jsx("col",{}),e.jsx("col",{className:"w-[1%]"}),e.jsx("col",{className:"w-[1%]"}),e.jsx("col",{className:"w-[1%]"}),e.jsx("col",{className:"w-[30%]"}),e.jsx("col",{className:"w-[1%]"})]}),e.jsx("thead",{className:"ltr:text-left rtl:text-right",children:e.jsxs("tr",{children:[e.jsx("th",{className:"py-1 px-1",children:" Operario"}),e.jsx("th",{className:"py-1 px-1",children:"Entrada"}),e.jsx("th",{className:"py-1 px-1",children:"Salida"}),e.jsx("th",{className:"py-1 px-1",children:"Ausente"}),e.jsx("th",{className:"py-1 px-1",children:"Observaciones"}),e.jsx("th",{className:"px-1 py-1",children:"ðŸ—‘ï¸"})]})}),e.jsx("tbody",{children:_.map((y,s)=>{var i,d,u;return e.jsxs("tr",{children:[e.jsxs("td",{className:"px-1 py-0.5 whitespace-nowrap",children:[e.jsx("input",{className:"sr-only",...I(`reportEmployees.${s}.id_employee`,{required:!0,valueAsNumber:!0})}),e.jsx(Y,{id:`reportEmployees.${s}.name_employee`,placeholder:"Seleccionar operario",...I(`reportEmployees.${s}.name_employee`),onClick:()=>Q(s)})]}),e.jsx("td",{className:"px-1 py-0.5 whitespace-nowrap",children:e.jsx(Y,{type:"time",...I(`reportEmployees.${s}.hour_start`,{required:S(`reportEmployees.${s}.absent`)?!1:"La hora de entrada es obligatoria"}),disabled:S(`reportEmployees.${s}.absent`)})}),e.jsx("td",{className:"px-1 py-0.5 whitespace-nowrap",children:e.jsx(Y,{type:"time",...I(`reportEmployees.${s}.hour_end`,{required:S(`reportEmployees.${s}.absent`)?!1:"La hora de salida es obligatoria"}),disabled:S(`reportEmployees.${s}.absent`)})}),e.jsx("td",{className:"px-1 py-0.5 whitespace-nowrap",children:e.jsxs("label",{htmlFor:`reportEmployees.${s}.absent`,className:"relative block h-8 w-14 rounded-full bg-gray-300 transition-colors [-webkit-tap-highlight-color:_transparent] has-checked:bg-blue-500 dark:bg-gray-600 dark:has-checked:bg-blue-600",children:[e.jsx("input",{type:"checkbox",id:`reportEmployees.${s}.absent`,className:"peer sr-only",checked:S(`reportEmployees.${s}.absent`),onChange:()=>{T(`reportEmployees.${s}.absent`,!S(`reportEmployees.${s}.absent`)),T(`reportEmployees.${s}.hour_start`,""),T(`reportEmployees.${s}.hour_end`,"")}}),e.jsx("span",{className:"absolute inset-y-0 start-0 m-1 size-6 rounded-full bg-gray-300 ring-[6px] ring-white transition-all ring-inset peer-checked:start-8 peer-checked:w-2 peer-checked:bg-white peer-checked:ring-transparent dark:bg-gray-600 dark:ring-gray-900 dark:peer-checked:bg-gray-900"})]})}),e.jsx("td",{className:"px-1 py-0.5 whitespace-nowrap",children:e.jsx(Y,{...I(`reportEmployees.${s}.observation`,{required:S(`reportEmployees.${s}.absent`)?"La observaciÃ³n es obligatoria si el operario estÃ¡ ausente":!1}),error:(u=(d=(i=f.reportEmployees)==null?void 0:i[s])==null?void 0:d.observation)==null?void 0:u.message})}),e.jsx("td",{className:"px-1 py-0.5 whitespace-nowrap",children:e.jsx(xe,{onClick:()=>X(s)})})]},y.id)})})]}),e.jsx("div",{className:"mt-4",children:e.jsx(ge,{"aria-label":"Agregar operario",onClick:K})})]}),e.jsx("div",{className:"mt-4 float-end",children:e.jsx(J,{variant:"outlineGreen",type:"submit",size:"sm",children:ee?"Cerrar":"Guardar"})})]}),e.jsx(Be,{open:x.open,onClose:x.closeModal,excludeIds:F(E??void 0).filter(y=>y!==null)})]})}function qe({onSuccess:t,selectedPhase:c,setSelectedPhase:a,idDailyReport:n,type:l}){var T,C;const[r,E]=g.useState(null),{selectedProject:z}=ae();if(!z)return null;const{phases_project:m}=z||{},N=(m==null?void 0:m.flatMap(f=>f.daily_reports))||[],P=f=>{E(N.find(_=>_.id===f)||null)};g.useEffect(()=>{n&&P(n)},[n,m]),le(`DailyReportInitForm-${z.id}-${n}`);const $=(r==null?void 0:r.status)==="finalizado",{openModal:x}=ie(),{register:v,handleSubmit:L,formState:{dirtyFields:A,errors:q},reset:I}=ne(),D=(f,_,o)=>_.some(p=>p.date_report===f.date_report&&p.id_phase===f.id_phase&&(o?p.id!==o:!0)),S=async f=>{try{if(l==="new"){if(D(f,N))throw new Error("Ya existe un parte diario para la fase y fecha seleccionadas");x("LOADING",{message:"Procesando requerimiento"});const{data:_,error:o}=await te.insertOne(f);if(o)throw new Error("Error inserting daily report:",{cause:o});_&&(I({id:_.id,id_phase:_.id_phase,date_report:_.date_report}),t(_.id),x("INFORMATION",{title:"ðŸ“„ Parte diario creado",message:e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"âœ… El parte diario ha sido inicializado correctamente"}),e.jsx("p",{children:"âž¡ï¸ continue con las actividades."})]})}))}else{if(D(f,N,f.id))throw new Error("Ya existe un parte diario para la fase y fecha seleccionadas");Object.keys(A).length>0&&(await Ie({dirtyFields:A,formData:f,onUpdate:te.update}),x("INFORMATION",{title:"ðŸ“„ Parte diario actualizado",message:e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"âœ… El parte diario ha sido actualizado correctamente"}),e.jsx("p",{children:"âž¡ï¸ continue con las actividades."})]})})),I(f),t(f.id)}}catch(_){x("ERROR",{message:`No se pudo actualizar la oportunidad. ${_.message||_}`})}},U=f=>{const _=Number(f.target.value);a(_)};return g.useEffect(()=>{r&&(a((r==null?void 0:r.id_phase)||""),I({id:(r==null?void 0:r.id)||0,id_phase:(r==null?void 0:r.id_phase)||void 0,date_report:(r==null?void 0:r.date_report)||new Date().toISOString().split("T")[0]}))},[r,I,a]),e.jsxs("form",{onSubmit:L(S),children:[e.jsxs("fieldset",{disabled:$,children:[e.jsx(fe,{label:"Etapa",...v("id_phase",{required:{value:!0,message:"Este campo es obligatorio"},valueAsNumber:!0}),onChange:f=>U(f),disabled:!1,value:c||"",error:(T=q.id_phase)==null?void 0:T.message,children:m==null?void 0:m.map(f=>e.jsx("option",{value:f.id,children:`[${f.id}] ${f.name}`},f.id))}),e.jsx(Y,{label:"Fecha",type:"date",...v("date_report",{required:{value:!0,message:"Este campo es obligatorio"}}),error:(C=q.date_report)==null?void 0:C.message})]}),e.jsx("div",{className:"mt-4 float-end",children:e.jsx(J,{variant:"outlineBlue",type:"submit",size:"sm",children:"Ir a Actividades"})})]})}function Ue({title:t,titleId:c,...a},n){return g.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor","aria-hidden":"true","data-slot":"icon",ref:n,"aria-labelledby":c},a),t?g.createElement("title",{id:c},t):null,g.createElement("path",{fillRule:"evenodd",d:"M5.22 8.22a.75.75 0 0 1 1.06 0L10 11.94l3.72-3.72a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.22 9.28a.75.75 0 0 1 0-1.06Z",clipRule:"evenodd"}))}const Ve=g.forwardRef(Ue),ue=[{id:1,name:"Inicializando",status:"in-progress",icon:e.jsx(Se,{})},{id:2,name:"Actividades",status:"pending",icon:e.jsx(Fe,{})},{id:3,name:"Personal",status:"pending",icon:e.jsx(ze,{})}];function ls({onClose:t,type:c,report:a}){le("DailyReportModal");const[n,l]=g.useState((a==null?void 0:a.id)||null),[r,E]=g.useState(null),{selectedProject:z,refreshProject:m,getReportsEmployees:N}=ae(),{phases_project:P}=z||{},$=(P==null?void 0:P.flatMap(o=>o.tasks))||[],[x,v]=g.useState(()=>ue.map(o=>({...o}))),[L,A]=g.useState(""),q=x.length>0?x.filter(o=>o.status==="done").length/x.length*100:0,I=()=>{const o=x.findIndex(p=>p.status==="in-progress");if(o!==-1){const p=[...x];p[o].status="done",o+1<p.length&&(p[o+1].status="in-progress"),v(p)}},D=o=>{const p=P==null?void 0:P.flatMap(F=>F.tasks),R=p==null?void 0:p.flatMap(F=>F.task_assignments),X=o.map(F=>R==null?void 0:R.filter(G=>G.id_task===F&&G.active));return X.length===0?[]:[...new Set(X.flatMap(F=>F).map(F=>F==null?void 0:F.id_employee))]},S=o=>{c!=="new"&&x.map((p,R)=>(R<=o&&(p.status="in-progress"),p))},U=({index:o,icon:p})=>e.jsxs("div",{className:`flex items-center font-semibold ${x[o].status==="done"?"text-green":""}`,onClick:()=>S(o),children:[e.jsx("div",{className:"size-5 mr-2",children:p}),e.jsx("span",{children:x[o].name})]}),T=()=>{const o=x.findIndex(p=>p.status==="in-progress");if(o>0){const p=[...x];p[o].status="pending",p[o-1].status="in-progress",v(p)}},C=({label:o})=>e.jsx("div",{className:"mt-4 w-fit",children:e.jsx(J,{size:"sm",variant:"light",type:"button",onClick:T,children:o||"Volver"})}),f=async o=>{const p=o.currentTarget.id;if(p!==(a==null?void 0:a.status)&&a){a.status=p;try{const{error:R}=await te.update({id:a==null?void 0:a.id,values:{status:p}});if(R)throw new Error(`Problemas al actualizar el status del reporte: ${R}`);m(),_()}catch(R){console.error("Error al actualizar el status del reporte:",R)}}},_=()=>{const o=document.getElementById("dropdown");o&&o.classList.toggle("hidden")};return e.jsx(me,{title:c==="new"?"Nuevo Parte Diario":`Editar Parte Diario # ${a==null?void 0:a.id}`,open:!0,zIndex:40,onClose:()=>{v(ue.map(o=>({...o}))),A(""),l(null),t()},width:"max-w-4xl",children:e.jsxs("div",{className:"px-6 pt-4 overflow-y-auto",style:{maxHeight:"calc(100vh - 270px)"},children:[c==="edit"&&e.jsx("div",{className:"absolute top-4 right-12",children:e.jsxs("div",{className:"flex flex-col items-end relative",children:[e.jsx("label",{htmlFor:"search-dropdown",className:"mb-2 text-sm font-medium text-gray-900 sr-only dark:text-white",children:"Cambiar status"}),e.jsx(J,{variant:(a==null?void 0:a.status)==="borrador"?"yellow":"green",size:"sm",id:"dropdown-button","data-dropdown-toggle":"dropdown",type:"button",onClick:_,disabled:(a==null?void 0:a.status)==="borrador",children:e.jsxs("div",{className:"inline-flex items-center gap-1",children:[a!=null&&a.status?a.status.slice(0,1).toUpperCase()+a.status.slice(1):""," ",e.jsx(Ve,{className:"size-4.5"})]})}),e.jsx("div",{id:"dropdown",className:"z-10 hidden bg-white divide-y divide-gray-100 rounded-lg shadow-sm dark:bg-zinc-700",children:e.jsxs("ul",{className:"py-2 text-sm text-zinc-700 dark:text-zinc-200","aria-labelledby":"dropdown-button",children:[e.jsx("li",{children:e.jsx("button",{type:"button",id:"borrador",className:"inline-flex w-full px-4 py-2 hover:bg-yellow-200 hover:text-zinc-900",onClick:f,children:"Borrador"})}),e.jsx("li",{children:e.jsx("button",{type:"button",id:"finalizado",className:"inline-flex w-full px-4 py-2 hover:bg-green-200 hover:text-zinc-900",onClick:f,children:"Finalizado"})})]})})]})}),P&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"w-full bg-zinc-300 dark:bg-zinc-600 rounded-full h-2.5",children:e.jsx("div",{className:"bg-green h-2.5 rounded-full transition-all duration-300 ease-out",style:{width:`${q}%`}})}),e.jsx("ol",{className:"flex justify-between text-zinc-500 dark:text-zinc-500",children:x.map((o,p)=>e.jsx("li",{className:"",children:e.jsx(U,{index:p,icon:o.icon})},Math.random()))}),x[0].status==="in-progress"&&e.jsx(qe,{selectedPhase:L,setSelectedPhase:A,type:c,idDailyReport:n,onSuccess:o=>{l(o),I(),m()}}),n&&$&&x[1].status==="in-progress"&&e.jsxs(e.Fragment,{children:[e.jsx($e,{idDailyReport:n,filteredTasks:$.filter(o=>o.id_phase===L),selectedPhase:L,type:c,onSuccess:o=>{E(D(o)),I(),m()}}),e.jsx(C,{label:"Ir a InicializaciÃ³n"})]}),n&&r&&x[2].status==="in-progress"&&e.jsxs(e.Fragment,{children:[e.jsx(Le,{idDailyReport:n,idsEmployees:r,type:c,onSuccess:()=>{I(),m(),N(),t()}}),e.jsx(C,{label:"Ir a Actividades"})]})]})]})})}export{ls as D};
