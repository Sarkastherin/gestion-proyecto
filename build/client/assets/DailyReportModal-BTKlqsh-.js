import{r as g,j as e}from"./chunk-PVWAREVJ-Cl_c9Jt0.js";import{M as me}from"./ModalBase-Czr0Q5I6.js";import{t as be,u as ae,r as D,l as se,n as te}from"./DataContext-BHROWMOn.js";import{u as ne,a as he}from"./index.esm-CLpX3RIH.js";import{I as G,S as fe}from"./Inputs-cvlDeTHR.js";import{B as J}from"./Buttons-DjYWmDVV.js";import{b as xe,c as ge}from"./Buttons-ByA9cNaT.js";import{u as ie,a as ye}from"./UIContext-9PjeG9pu.js";import{u as je}from"./updatesArraysFields-CDmdxi8j.js";import{f as ke,c as le,a as _e}from"./realTime-Csd-v9-x.js";import{r as ve}from"./index-DG_GJQZz.js";import{u as we}from"./ContactsContext-BtjVusI7.js";import{u as Ee}from"./useModalState-Dynfoma4.js";import{B as oe}from"./Badge-BNjmnaCE.js";import{E as Ne}from"./EntityTable-DKwDIY9O.js";import{u as Ie}from"./updatesSingleRow-C5gkTyzt.js";import{F as Fe}from"./ClipboardDocumentCheckIcon-C0qHNpyc.js";import{F as ze}from"./UserGroupIcon-DFLFYX-R.js";function Se({title:s,titleId:c,...t},n){return g.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:n,"aria-labelledby":c},t),s?g.createElement("title",{id:c},s):null,g.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m3.75 9v6m3-3H9m1.5-12H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z"}))}const Re=g.forwardRef(Se);function Te({reportTasks:s,id_task:c,idDailyReport:t}){return Math.max(...s.filter(d=>d.id_task===c&&d.id_daily_report<=t).map(d=>d.progress),0)}function Oe({reportTasks:s,id_task:c,idDailyReport:t,progress:n}){return s.some(d=>d.id_task===c&&d.id_daily_report>t&&d.progress>n)}function Me({reportTasks:s,id_task:c,idDailyReport:t}){return s.some(n=>n.id_task===c&&n.id_daily_report===t)}function Ae({reportTasks:s,id_task:c,idDailyReport:t}){const n=s.find(d=>d.id_task===c&&d.id_daily_report===t);return(n==null?void 0:n.progress)??0}function Pe({filteredTasks:s,reportTasks:c,idDailyReport:t}){return s.map(n=>{const d=c.find(o=>o.id_task===n.id&&o.id_daily_report===t);return d?{...d,description:n.name}:{id:0,created_at:"",id_task:n.id,description:n.name,id_daily_report:t,progress:0}}).filter(n=>Math.max(...c.filter(o=>o.id_task===n.id_task&&o.id_daily_report<=t).map(o=>o.progress),0)<100||c.some(o=>o.id_task===n.id_task&&o.id_daily_report===t))}const ce=async({task:s,selectedPhase:c})=>{const t={name:s.description,id_phase:c,duration:0,planned:!1},{data:n,error:d}=await be.insertOne(t);if(d)throw new Error(d.message);return n};function pe({message:s,children:c}){const[t,n]=g.useState(!1),[d,o]=g.useState({top:0,left:0}),N=g.useRef(null),F=()=>{if(N.current){const w=N.current.getBoundingClientRect();o({top:w.bottom+window.scrollY+6,left:w.left+window.scrollX+w.width/2}),n(!0)}},u=()=>n(!1);return e.jsxs(e.Fragment,{children:[e.jsx("span",{ref:N,className:"relative group cursor-pointer",onMouseEnter:F,onMouseLeave:u,tabIndex:0,onFocus:F,onBlur:u,children:c}),t&&ve.createPortal(e.jsx("span",{className:"mt-2 pointer-events-none fixed z-[9999] w-max min-w-[180px] rounded px-2 py-1.5 text-xs font-semibold shadow-lg border border-zinc-700 bg-zinc-900 text-white dark:bg-zinc-200 dark:text-zinc-900",style:{top:d.top,left:d.left,transform:"translateX(-50%)"},children:s}),document.body)]})}function $e({idDailyReport:s,filteredTasks:c,selectedPhase:t,onSuccess:n,type:d}){ke(),le();const[o,N]=g.useState(null),{selectedProject:F}=ae();if(!F)return null;const{phases_project:u}=F||{};if(!u)return null;const w=(u==null?void 0:u.flatMap(r=>r.daily_reports))||[],A=r=>{N(w.find(i=>i.id===r)||null)};g.useEffect(()=>{s&&A(s)},[s,u]);const E=w.filter(r=>r.id_phase===t).flatMap(r=>r.report_tasks),{openModal:z,closeModal:$}=ie(),[q,S]=g.useState([]),B=(o==null?void 0:o.status)==="finalizado";d==="edit"||(o==null||o.status);const U={reportTasks:Pe({filteredTasks:c,reportTasks:E,idDailyReport:s})},{control:P,register:C,handleSubmit:V,watch:x,reset:a,formState:{isDirty:p,dirtyFields:k}}=ne({defaultValues:U}),{fields:Y,append:K,remove:I}=he({control:P,name:"reportTasks"}),Q=()=>{K({id_task:0,description:"",progress:0,id_daily_report:s})},X=r=>{const h=x("reportTasks")[r],f=o==null?void 0:o.report_tasks.find(y=>y.id_task===h.id_task&&y.id_daily_report===h.id_daily_report);f&&f.id&&S(y=>[...y,f.id]),I(r)};function Z(r,i){if(!i)return{tasks:r.filter(f=>f.progress>0)};const h={tasks:[],dirtyFields:[]};return r.forEach((f,y)=>{f.progress>0&&(h.tasks.push(f),h.dirtyFields.push(i[y]))}),h}const re=async(r,i,h)=>{const{tasks:f,dirtyFields:y}=Z(r,i);await Promise.all(f.map(async(m,R)=>{const _=m.id_task>0,v=y?y[R]??{}:{},W=Object.values(v).some(O=>O);if(_&&W){const O={id_task:m.id_task,id_daily_report:s,progress:m.progress};h.push(m.id_task);const{error:H}=await D.insertOne(O);if(H)throw new Error(H.message)}else if(!_){const O=await ce({task:m,selectedPhase:t});if(O&&"id"in O){const H={id_task:O.id,id_daily_report:s,progress:m.progress},{error:M}=await D.insertOne(H);if(M)throw new Error(M.message)}}})),S([]),z("INFORMATION",{title:"ðŸ“ Avance de actividades creado",message:e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"âœ… Las actividades han sido creadas correctamente"}),e.jsx("p",{children:"âž¡ï¸ continue con la carga de horas del personal."})]})})},ee=async(r,i,h)=>{const{tasks:f,dirtyFields:y}=Z(r,i);await Promise.all((y??[]).map(async(R,_)=>{if(!R)return;const v=f[_];if(!v)return;const W=v.id_task>0,O=v.id>0,H=Object.values(R).some(M=>M);if(!W){const M=await ce({task:v,selectedPhase:t});if(M&&"id"in M){const L={id_task:M.id,id_daily_report:s,progress:v.progress},{error:de}=await D.insertOne(L);if(de)throw new Error(de.message)}}if(!O){const M={id_task:v.id_task,id_daily_report:s,progress:v.progress},{error:L}=await D.insertOne(M);if(L)throw new Error(L.message)}if(O&&H){const M={id_task:v.id_task,id_daily_report:s,progress:v.progress};h.push(v.id_task);const{error:L}=await D.update({id:v.id,values:M});if(L)throw new Error(L.message)}}));const m=(i??[]).map((R,_)=>{if(!R||!r[_])return null;const v=r[_];if(v.progress===0||v.id_task===0)return null;const W=o==null?void 0:o.report_tasks.find(L=>L.id_task===v.id_task&&L.id_daily_report===v.id_daily_report),O=W?{...v,id:W.id}:v;h.push(O.id_task);const{description:H,...M}=O;return M}).filter(R=>!!R);await je({fieldName:"reportTasks",fieldsArray:m,dirtyFields:{reportTasks:i??[]},fieldsDelete:q,onInsert:D.insertOne,onRemove:R=>D.remove({id:R}),onUpdate:D.update}),z("INFORMATION",{title:"ðŸ“ Avance de actividades actualizado",message:e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"âœ… El avance de actividades ha sido actualizado correctamente"}),e.jsx("p",{children:"âž¡ï¸ continue con las actividades."})]})})},j=async r=>{try{const{reportTasks:i}=r;let h=[];if(d==="new"){if(!p&&q.length===0){z("CONFIRMATION",{title:"âš ï¸ Sin cambios",message:e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"No hay datos para agregar"}),e.jsx("p",{children:"Â¿Desea continuar con el proceso de carga de personal?"})]}),onConfirm:()=>{n([]),$()}});return}z("LOADING",{message:"Procesando requerimiento"});const f=k.reportTasks??[];await re(i,f,h)}else if(Object.keys(k).length>0){const f=k.reportTasks??[];await ee(i,f,h)}else i.map(f=>h.push(f.id_task));n(h)}catch(i){console.error(i),z("ERROR",{message:`Error al procesar el requerimiento: ${i.message||i}`})}},l=r=>{console.error("Errors:",r),z("ERROR",{message:"Error en el formulario, verifique los datos ingresados."})};return e.jsxs("form",{onSubmit:V(j,l),children:[e.jsxs("fieldset",{disabled:B,children:[e.jsxs("table",{className:"w-full text-sm table-auto divide-zinc-200 dark:divide-zinc-700",children:[e.jsxs("colgroup",{children:[e.jsx("col",{}),e.jsx("col",{className:"w-[14%]"}),e.jsx("col",{className:"w-[10%]"}),e.jsx("col",{className:"w-[1%]"})]}),e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"py-1 px-1 text-left",children:"DescripciÃ³n"}),e.jsx("th",{className:"py-1 px-1",children:"Avance en PD"}),e.jsx("th",{className:"py-1 px-1",children:"Nuevo avance"}),e.jsx("th",{className:"px-1 py-1",children:"ðŸ—‘ï¸"})]})}),e.jsx("tbody",{children:Y.map((r,i)=>{const h=Te({reportTasks:E,id_task:r.id_task,idDailyReport:s}),f=Ae({reportTasks:E,id_task:r.id_task,idDailyReport:s}),y=Me({reportTasks:E,id_task:r.id_task,idDailyReport:s}),m=Oe({reportTasks:E,id_task:r.id_task,idDailyReport:s,progress:f}),R=[25,50,75,100].filter(_=>_>=h);return e.jsxs("tr",{className:y?"bg-green-100/70 dark:bg-green-600/20":"",children:[e.jsxs("td",{className:"relative px-1 py-0.5 whitespace-nowrap",children:[e.jsx(G,{...C(`reportTasks.${i}.description`,{required:!0}),defaultValue:r.description,readOnly:r.id_task!==0}),y&&e.jsx("div",{className:"absolute w-full top-0 -left-2 h-full flex items-center justify-end pr-1",children:e.jsx(pe,{message:"Reportada en este parte diario",children:e.jsx("span",{className:"text-xs rounded px-1 py-0.5 bg-yellow-300",children:"ðŸ“Œ"})})})]}),e.jsx("td",{className:"px-1 py-0.5 whitespace-nowrap",children:e.jsx(G,{disabled:!0,value:h+"%"})}),e.jsxs("td",{className:"relative px-1 py-0.5 whitespace-nowrap",children:[e.jsxs(fe,{...C(`reportTasks.${i}.progress`,{valueAsNumber:!0,validate:_=>_===0||_>=h||"El avance no puede ser menor al actual"}),defaultValue:f,disabled:m,children:[e.jsxs("option",{value:f,children:[f,"%"]}),R.filter(_=>_!==f).map(_=>e.jsxs("option",{value:_,children:[_,"%"]},_))]}),m&&e.jsx("div",{className:"absolute w-full top-0 -left-2 h-full flex items-center justify-end pr-1",children:e.jsx(pe,{message:"No editable: existe un avance posterior registrado",children:e.jsx("span",{children:"ðŸ”’"})})})]}),e.jsx("td",{className:"px-1 py-0.5 whitespace-nowrap",children:e.jsx(xe,{onClick:()=>X(i),disabled:m})})]},r.id)})})]}),e.jsx("div",{className:"mt-4",children:e.jsx(ge,{"aria-label":"Agregar actividad no planificada",onClick:Q})})]}),e.jsx("div",{className:"mt-4 float-end",children:e.jsx(J,{variant:"outlineBlue",type:"submit",size:"sm",children:"Ir a Personal"})})]})}const Ce=[{name:"Id",selector:s=>s.id,width:"80px"},{name:"Empleado",selector:s=>s.contacto_nombre,wrap:!0},{name:"Puesto",selector:s=>s.puesto||"",width:"150px"}];function Be({open:s,onClose:c,excludeIds:t=[]}){const{setSelectedEmployee:n}=ye(),{employees:d}=we(),[o,N]=g.useState([]),F=u=>{n({...u}),c()};return g.useEffect(()=>{if(d&&d.length>0){const u=d.filter(w=>!t.includes(w.id));N(u)}},[d,t]),e.jsx(me,{title:"Listado de Empleados",open:s,zIndex:40,onClose:c,width:"max-w-4xl",footer:{btnSecondary:{label:"Cancelar",handleOnClick:c}},children:e.jsx("div",{className:"px-6 pt-6 overflow-y-auto",style:{maxHeight:"calc(100vh - 270px)"},children:e.jsx(Ne,{columns:Ce,data:o,onRowClick:F,filterFields:[{key:"contacto_nombre",label:"Empleado",autoFilter:!0},{key:"puesto",label:"Puesto",autoFilter:!0}]})})})}function Le({idDailyReport:s,idsEmployees:c,type:t,onSuccess:n}){_e();const[d,o]=g.useState(null),[N,F]=g.useState(null),{selectedProject:u,getProjectById:w}=ae(),{openModal:A}=ie(),b=Ee(),{employees:E}=we(),{setSelectedEmployee:z,selectedEmployee:$}=ye(),{control:q,register:S,handleSubmit:B,watch:T,reset:U,setValue:P,formState:{dirtyFields:C,errors:V}}=ne({defaultValues:{reportEmployees:[]}}),{fields:x,append:a,remove:p}=he({control:q,name:"reportEmployees"});g.useEffect(()=>{if(u!=null&&u.phases_project&&s){const l=(u.phases_project.flatMap(r=>r.daily_reports)||[]).find(r=>r.id===s)||null;o(l)}else o(null)},[u,s]);const k=g.useMemo(()=>new Map(E==null?void 0:E.map(j=>[j.id,j.contacto_nombre])),[E]);g.useEffect(()=>{if(!d){U({reportEmployees:[]},{keepDirty:!1,keepValues:!1});return}const j=d.report_employees??[],l=d.status==="finalizado",r=j.map(y=>y.id_employee)??[],i=l?r:[...c,...r],f=[...new Set(i)].map(y=>{const m=j.find(R=>R.id_employee===y);return{id:(m==null?void 0:m.id)??null,id_daily_report:s,id_employee:y,hour_start:(m==null?void 0:m.hour_start)??"",hour_end:(m==null?void 0:m.hour_end)??"",observation:(m==null?void 0:m.observation)??"",absent:(m==null?void 0:m.absent)??!1,name_employee:k.get(y)??""}});U({reportEmployees:f},{keepDirty:!1,keepValues:!1})},[d,c,k,s,U]),g.useEffect(()=>{$&&N!==null&&(P(`reportEmployees.${N}.id_employee`,$.id,{shouldDirty:!0}),P(`reportEmployees.${N}.name_employee`,$.contacto_nombre,{shouldDirty:!0}))},[$,N,P]);const Y=j=>p(j),K=()=>a({id:null,id_daily_report:s,id_employee:0,hour_start:"",hour_end:"",observation:"",absent:!1,name_employee:""}),I=j=>(T("reportEmployees")??[]).map((l,r)=>r!==j?l.id_employee:null).filter(l=>l!==null&&l!==0),Q=j=>{F(j),z(null),b.openModal({excludeIds:I(j).filter(l=>l!==null)})},X=async j=>{try{const{reportEmployees:l}=j;if(t==="new"){A("LOADING",{message:"Procesando requerimiento"});const r=l.map(y=>{const{id:m,name_employee:R,..._}=y;return _}),{data:i,error:h}=await se.insert(r);if(h)throw new Error(h.message);const f=await Z(s);i&&(n(),A("INFORMATION",{title:"â±ï¸ Horas cargadas",message:e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"âœ… Las horas trabajadas han sido cargadas correctamente"}),f&&e.jsxs("p",{children:["âž¡ï¸ El status del parte diario se ha actualizado a ",e.jsx(oe,{variant:"green",children:"Finalizado"})]})]})}))}else{if(Object.keys(C).length>0){const r=l.map(h=>{const{id:f,name_employee:y,...m}=h;return f===null?m:{id:f,...m}});await je({fieldName:"reportEmployees",dirtyFields:C,fieldsArray:r,fieldsDelete:[],onInsert:se.insertOne,onRemove:h=>se.remove({id:h}),onUpdate:se.update});const i=await Z(s);A("INFORMATION",{title:"â±ï¸ Horas actualizadas",message:e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"âœ… Las horas trabajadas han sido actualizadas correctamente"}),i&&e.jsxs("p",{children:["âž¡ï¸ El status del parte diario se ha actualizado a ",e.jsx(oe,{variant:"green",children:"Finalizado"})]})]})})}else await Z(s)&&A("INFORMATION",{title:"Parte diario Actualizado",message:e.jsxs("p",{children:["âž¡ï¸ El status del parte diario se ha actualizado a ",e.jsx(oe,{variant:"green",children:"Finalizado"})]})});n()}}catch{A("ERROR",{message:"Error al procesar el requerimiento"})}},Z=async j=>{if(!u)return;const l=await w(u.id),r=l==null?void 0:l.phases_project.flatMap(m=>m.daily_reports),i=r==null?void 0:r.find(m=>m.id===s),h=!!(i!=null&&i.report_tasks&&i.report_tasks.length>0),f=!!(i!=null&&i.report_employees&&i.report_employees.length>0);if(!h||!f||(i==null?void 0:i.status)==="finalizado")return;const{error:y}=await te.update({id:j,values:{status:"finalizado"}});if(y)throw new Error("Problemas al actualizar el status del reporte:",{cause:y});return!0},re=j=>{console.log("FORM ERRORS",j)};if(!(u!=null&&u.phases_project))return e.jsx("p",{className:"text-center py-4",children:"Cargando proyecto..."});if(!d)return e.jsx("p",{className:"text-center py-4",children:"Cargando parte diario..."});const ee=d.status==="finalizado";return e.jsxs(e.Fragment,{children:[e.jsxs("form",{onSubmit:B(X,re),children:[e.jsxs("fieldset",{disabled:ee,children:[e.jsxs("table",{className:"w-full text-sm table-auto divide-zinc-200 dark:divide-zinc-700",children:[e.jsxs("colgroup",{children:[e.jsx("col",{}),e.jsx("col",{className:"w-[1%]"}),e.jsx("col",{className:"w-[1%]"}),e.jsx("col",{className:"w-[1%]"}),e.jsx("col",{className:"w-[30%]"}),e.jsx("col",{className:"w-[1%]"})]}),e.jsx("thead",{className:"ltr:text-left rtl:text-right",children:e.jsxs("tr",{children:[e.jsx("th",{className:"py-1 px-1",children:" Operario"}),e.jsx("th",{className:"py-1 px-1",children:"Entrada"}),e.jsx("th",{className:"py-1 px-1",children:"Salida"}),e.jsx("th",{className:"py-1 px-1",children:"Ausente"}),e.jsx("th",{className:"py-1 px-1",children:"Observaciones"}),e.jsx("th",{className:"px-1 py-1",children:"ðŸ—‘ï¸"})]})}),e.jsx("tbody",{children:x.map((j,l)=>{var r,i,h;return e.jsxs("tr",{children:[e.jsxs("td",{className:"px-1 py-0.5 whitespace-nowrap",children:[e.jsx("input",{className:"sr-only",...S(`reportEmployees.${l}.id_employee`,{required:!0,valueAsNumber:!0})}),e.jsx(G,{id:`reportEmployees.${l}.name_employee`,placeholder:"Seleccionar operario",...S(`reportEmployees.${l}.name_employee`),onClick:()=>Q(l)})]}),e.jsx("td",{className:"px-1 py-0.5 whitespace-nowrap",children:e.jsx(G,{type:"time",...S(`reportEmployees.${l}.hour_start`,{required:T(`reportEmployees.${l}.absent`)?!1:"La hora de entrada es obligatoria"}),disabled:T(`reportEmployees.${l}.absent`)})}),e.jsx("td",{className:"px-1 py-0.5 whitespace-nowrap",children:e.jsx(G,{type:"time",...S(`reportEmployees.${l}.hour_end`,{required:T(`reportEmployees.${l}.absent`)?!1:"La hora de salida es obligatoria"}),disabled:T(`reportEmployees.${l}.absent`)})}),e.jsx("td",{className:"px-1 py-0.5 whitespace-nowrap",children:e.jsxs("label",{htmlFor:`reportEmployees.${l}.absent`,className:"relative block h-8 w-14 rounded-full bg-gray-300 transition-colors [-webkit-tap-highlight-color:_transparent] has-checked:bg-blue-500 dark:bg-gray-600 dark:has-checked:bg-blue-600",children:[e.jsx("input",{type:"checkbox",id:`reportEmployees.${l}.absent`,className:"peer sr-only",checked:T(`reportEmployees.${l}.absent`),onChange:()=>{P(`reportEmployees.${l}.absent`,!T(`reportEmployees.${l}.absent`)),P(`reportEmployees.${l}.hour_start`,""),P(`reportEmployees.${l}.hour_end`,"")}}),e.jsx("span",{className:"absolute inset-y-0 start-0 m-1 size-6 rounded-full bg-gray-300 ring-[6px] ring-white transition-all ring-inset peer-checked:start-8 peer-checked:w-2 peer-checked:bg-white peer-checked:ring-transparent dark:bg-gray-600 dark:ring-gray-900 dark:peer-checked:bg-gray-900"})]})}),e.jsx("td",{className:"px-1 py-0.5 whitespace-nowrap",children:e.jsx(G,{...S(`reportEmployees.${l}.observation`,{required:T(`reportEmployees.${l}.absent`)?"La observaciÃ³n es obligatoria si el operario estÃ¡ ausente":!1}),error:(h=(i=(r=V.reportEmployees)==null?void 0:r[l])==null?void 0:i.observation)==null?void 0:h.message})}),e.jsx("td",{className:"px-1 py-0.5 whitespace-nowrap",children:e.jsx(xe,{onClick:()=>Y(l)})})]},j.id)})})]}),e.jsx("div",{className:"mt-4",children:e.jsx(ge,{"aria-label":"Agregar operario",onClick:K})})]}),e.jsx("div",{className:"mt-4 float-end",children:e.jsx(J,{variant:"outlineGreen",type:"submit",size:"sm",children:ee?"Cerrar":"Guardar"})})]}),e.jsx(Be,{open:b.open,onClose:b.closeModal,excludeIds:I(N??void 0).filter(j=>j!==null)})]})}function qe({onSuccess:s,selectedPhase:c,setSelectedPhase:t,idDailyReport:n,type:d}){var C,V;const[o,N]=g.useState(null),{selectedProject:F}=ae();if(!F)return null;const{phases_project:u}=F||{},w=(u==null?void 0:u.flatMap(x=>x.daily_reports))||[],A=x=>{N(w.find(a=>a.id===x)||null)};g.useEffect(()=>{n&&A(n)},[n,u]),le(`DailyReportInitForm-${F.id}-${n}`);const b=(o==null?void 0:o.status)==="finalizado",{openModal:E}=ie(),{register:z,handleSubmit:$,formState:{dirtyFields:q,errors:S},reset:B}=ne(),T=(x,a,p)=>a.some(k=>k.date_report===x.date_report&&k.id_phase===x.id_phase&&(p?k.id!==p:!0)),U=async x=>{try{if(d==="new"){if(T(x,w))throw new Error("Ya existe un parte diario para la fase y fecha seleccionadas");E("LOADING",{message:"Procesando requerimiento"});const{data:a,error:p}=await te.insertOne(x);if(p)throw new Error("Error inserting daily report:",{cause:p});a&&(B({id:a.id,id_phase:a.id_phase,date_report:a.date_report}),s(a.id),E("INFORMATION",{title:"ðŸ“„ Parte diario creado",message:e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"âœ… El parte diario ha sido inicializado correctamente"}),e.jsx("p",{children:"âž¡ï¸ continue con las actividades."})]})}))}else{if(T(x,w,x.id))throw new Error("Ya existe un parte diario para la fase y fecha seleccionadas");Object.keys(q).length>0&&(await Ie({dirtyFields:q,formData:x,onUpdate:te.update}),E("INFORMATION",{title:"ðŸ“„ Parte diario actualizado",message:e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"âœ… El parte diario ha sido actualizado correctamente"}),e.jsx("p",{children:"âž¡ï¸ continue con las actividades."})]})})),B(x),s(x.id)}}catch(a){E("ERROR",{message:`No se pudo actualizar la oportunidad. ${a.message||a}`})}},P=x=>{const a=Number(x.target.value);t(a)};return g.useEffect(()=>{o&&(t((o==null?void 0:o.id_phase)||""),B({id:(o==null?void 0:o.id)||0,id_phase:(o==null?void 0:o.id_phase)||void 0,date_report:(o==null?void 0:o.date_report)||new Date().toISOString().split("T")[0]}))},[o,B,t]),e.jsxs("form",{onSubmit:$(U),children:[e.jsxs("fieldset",{disabled:b,children:[e.jsx(fe,{label:"Etapa",...z("id_phase",{required:{value:!0,message:"Este campo es obligatorio"},valueAsNumber:!0}),onChange:x=>P(x),disabled:!1,value:c||"",error:(C=S.id_phase)==null?void 0:C.message,children:u==null?void 0:u.map(x=>e.jsx("option",{value:x.id,children:`[${x.id}] ${x.name}`},x.id))}),e.jsx(G,{label:"Fecha",type:"date",...z("date_report",{required:{value:!0,message:"Este campo es obligatorio"}}),error:(V=S.date_report)==null?void 0:V.message})]}),e.jsx("div",{className:"mt-4 float-end",children:e.jsx(J,{variant:"outlineBlue",type:"submit",size:"sm",children:"Ir a Actividades"})})]})}function Ue({title:s,titleId:c,...t},n){return g.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor","aria-hidden":"true","data-slot":"icon",ref:n,"aria-labelledby":c},t),s?g.createElement("title",{id:c},s):null,g.createElement("path",{fillRule:"evenodd",d:"M5.22 8.22a.75.75 0 0 1 1.06 0L10 11.94l3.72-3.72a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.22 9.28a.75.75 0 0 1 0-1.06Z",clipRule:"evenodd"}))}const Ve=g.forwardRef(Ue),ue=[{id:1,name:"Inicializando",status:"in-progress",icon:e.jsx(Re,{})},{id:2,name:"Actividades",status:"pending",icon:e.jsx(Fe,{})},{id:3,name:"Personal",status:"pending",icon:e.jsx(ze,{})}];function ls({onClose:s,type:c,report:t}){le("DailyReportModal");const[n,d]=g.useState((t==null?void 0:t.id)||null),[o,N]=g.useState(null),{selectedProject:F,refreshProject:u}=ae(),{phases_project:w}=F||{},A=(w==null?void 0:w.flatMap(a=>a.tasks))||[],[b,E]=g.useState(()=>ue.map(a=>({...a}))),[z,$]=g.useState(""),q=b.length>0?b.filter(a=>a.status==="done").length/b.length*100:0,S=()=>{const a=b.findIndex(p=>p.status==="in-progress");if(a!==-1){const p=[...b];p[a].status="done",a+1<p.length&&(p[a+1].status="in-progress"),E(p)}},B=a=>{const p=w==null?void 0:w.flatMap(I=>I.tasks),k=p==null?void 0:p.flatMap(I=>I.task_assignments),Y=a.map(I=>k==null?void 0:k.filter(X=>X.id_task===I&&X.active));return Y.length===0?[]:[...new Set(Y.flatMap(I=>I).map(I=>I==null?void 0:I.id_employee))]},T=a=>{c!=="new"&&b.map((p,k)=>(k<=a&&(p.status="in-progress"),p))},U=({index:a,icon:p})=>e.jsxs("div",{className:`flex items-center font-semibold ${b[a].status==="done"?"text-green":""}`,onClick:()=>T(a),children:[e.jsx("div",{className:"size-5 mr-2",children:p}),e.jsx("span",{children:b[a].name})]}),P=()=>{const a=b.findIndex(p=>p.status==="in-progress");if(a>0){const p=[...b];p[a].status="pending",p[a-1].status="in-progress",E(p)}},C=({label:a})=>e.jsx("div",{className:"mt-4 w-fit",children:e.jsx(J,{size:"sm",variant:"light",type:"button",onClick:P,children:a||"Volver"})}),V=async a=>{const p=a.currentTarget.id;if(p!==(t==null?void 0:t.status)&&t){t.status=p;try{const{error:k}=await te.update({id:t==null?void 0:t.id,values:{status:p}});if(k)throw new Error(`Problemas al actualizar el status del reporte: ${k}`);u(),x()}catch(k){console.error("Error al actualizar el status del reporte:",k)}}},x=()=>{const a=document.getElementById("dropdown");a&&a.classList.toggle("hidden")};return e.jsx(me,{title:c==="new"?"Nuevo Parte Diario":`Editar Parte Diario # ${t==null?void 0:t.id}`,open:!0,zIndex:40,onClose:()=>{E(ue.map(a=>({...a}))),$(""),d(null),s()},width:"max-w-4xl",children:e.jsxs("div",{className:"px-6 pt-4 overflow-y-auto",style:{maxHeight:"calc(100vh - 270px)"},children:[c==="edit"&&e.jsx("div",{className:"absolute top-4 right-12",children:e.jsxs("div",{className:"flex flex-col items-end relative",children:[e.jsx("label",{htmlFor:"search-dropdown",className:"mb-2 text-sm font-medium text-gray-900 sr-only dark:text-white",children:"Cambiar status"}),e.jsx(J,{variant:(t==null?void 0:t.status)==="borrador"?"yellow":"green",size:"sm",id:"dropdown-button","data-dropdown-toggle":"dropdown",type:"button",onClick:x,disabled:(t==null?void 0:t.status)==="borrador",children:e.jsxs("div",{className:"inline-flex items-center gap-1",children:[t!=null&&t.status?t.status.slice(0,1).toUpperCase()+t.status.slice(1):""," ",e.jsx(Ve,{className:"size-4.5"})]})}),e.jsx("div",{id:"dropdown",className:"z-10 hidden bg-white divide-y divide-gray-100 rounded-lg shadow-sm dark:bg-zinc-700",children:e.jsxs("ul",{className:"py-2 text-sm text-zinc-700 dark:text-zinc-200","aria-labelledby":"dropdown-button",children:[e.jsx("li",{children:e.jsx("button",{type:"button",id:"borrador",className:"inline-flex w-full px-4 py-2 hover:bg-yellow-200 hover:text-zinc-900",onClick:V,children:"Borrador"})}),e.jsx("li",{children:e.jsx("button",{type:"button",id:"finalizado",className:"inline-flex w-full px-4 py-2 hover:bg-green-200 hover:text-zinc-900",onClick:V,children:"Finalizado"})})]})})]})}),w&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"w-full bg-zinc-300 dark:bg-zinc-600 rounded-full h-2.5",children:e.jsx("div",{className:"bg-green h-2.5 rounded-full transition-all duration-300 ease-out",style:{width:`${q}%`}})}),e.jsx("ol",{className:"flex justify-between text-zinc-500 dark:text-zinc-500",children:b.map((a,p)=>e.jsx("li",{className:"",children:e.jsx(U,{index:p,icon:a.icon})},Math.random()))}),b[0].status==="in-progress"&&e.jsx(qe,{selectedPhase:z,setSelectedPhase:$,type:c,idDailyReport:n,onSuccess:a=>{d(a),S(),u()}}),n&&A&&b[1].status==="in-progress"&&e.jsxs(e.Fragment,{children:[e.jsx($e,{idDailyReport:n,filteredTasks:A.filter(a=>a.id_phase===z),selectedPhase:z,type:c,onSuccess:a=>{N(B(a)),S(),u()}}),e.jsx(C,{label:"Ir a InicializaciÃ³n"})]}),n&&o&&b[2].status==="in-progress"&&e.jsxs(e.Fragment,{children:[e.jsx(Le,{idDailyReport:n,idsEmployees:o,type:c,onSuccess:()=>{S(),u(),s()}}),e.jsx(C,{label:"Ir a Actividades"})]})]})]})})}export{ls as D};
