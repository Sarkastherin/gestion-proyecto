import{r as f,j as e,w as D}from"./chunk-PVWAREVJ-Cl_c9Jt0.js";import{a as O,u as R}from"./UIContext-9PjeG9pu.js";import{a as k}from"./Containers-ZXGJ7diH.js";import{I as T}from"./Inputs-cvlDeTHR.js";import{a as M}from"./Cards-BPIQ6iiA.js";import{u as P,a as U}from"./index.esm-CLpX3RIH.js";import{b as B,c as q}from"./Buttons-ByA9cNaT.js";import{u as $}from"./updatesArraysFields-CDmdxi8j.js";import{u as G}from"./fieldsChange-DvNB-iS-.js";import{e as m,u as L}from"./DataContext-BHROWMOn.js";import{F as V}from"./FooterForms-CbBXM1X1.js";import{u as _}from"./realTime-Csd-v9-x.js";import"./supabaseClient-O5NoNd5h.js";import"./IconComponent-CkWBZZXK.js";import"./arrow-left-3CO6tBoR.js";import"./Buttons-DjYWmDVV.js";import"./Link-DZjWQWvu.js";import"./functions-CIXTKjf3.js";import"./TrashIcon-CpHN25SK.js";import"./ContactsContext-BtjVusI7.js";function H({defaultValues:d,idOpportunity:l,mode:p}){const[r,j]=f.useState(!1),[y,u]=f.useState([]),{editByStatus:c}=O(),{openModal:i}=R(),{register:w,formState:{errors:h,dirtyFields:N,isSubmitSuccessful:g,isDirty:x},control:b,handleSubmit:v,reset:F}=P({defaultValues:d??{phases:[]}}),{fields:S,append:E,remove:A}=U({control:b,name:"phases"}),I=async a=>{if(!x){i("INFORMATION",{title:"Formulario sin cambios",message:"No hay cambios para actualizar'"});return}i("LOADING");try{const{phases:s}=a,t=await $({fieldName:"phases",fieldsArray:s,dirtyFields:N,fieldsDelete:y,onInsert:m.insertOne,onRemove:n=>m.remove({id:n}),onUpdate:m.update});i("SUCCESS",{message:"Se ha actualizado la oportunidad"});const o=s.filter(n=>"id"in n&&typeof n.id=="number");F({phases:[...o,...Array.isArray(t)?t:[]]}),u([])}catch(s){i("ERROR",{message:`No se pudo actualizar la oportunidad. Error: ${String(s)}`})}},z=()=>{E({id_opportunity:l??null,name:""})},C=a=>{const s=d.phases[a];A(a),s&&"id"in s&&s.id!==void 0&&u(t=>[...t,s.id])};return G({isSubmitSuccessful:g,isDirty:x}),e.jsx(e.Fragment,{children:e.jsxs("form",{className:" flex flex-col gap-6",onSubmit:v(I),children:[e.jsx("fieldset",{disabled:!r,children:e.jsx(M,{title:"Etapas",children:e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("table",{className:"min-w-full table-auto divide-y-2 divide-zinc-200 dark:divide-zinc-700",children:[e.jsxs("colgroup",{children:[e.jsx("col",{className:"w-[1%]"}),e.jsx("col",{}),e.jsx("col",{className:"w-[1%]"})]}),e.jsx("thead",{className:"ltr:text-left rtl:text-right",children:e.jsxs("tr",{className:"*:font-medium *:text-zinc-900 dark:*:text-white",children:[e.jsx("th",{className:"px-3 py-2 whitespace-nowrap",children:"#"}),e.jsx("th",{className:"px-3 py-2 whitespace-nowrap",children:"Etapas"}),e.jsx("th",{className:"px-3 py-2 whitespace-nowrap",children:"ðŸ—‘ï¸"})]})}),e.jsx("tbody",{className:"divide-y divide-zinc-200 dark:divide-zinc-700",children:S.map((a,s)=>{var t,o;return e.jsxs("tr",{className:"*:text-zinc-900 *:first:font-medium dark:*:text-white",children:[e.jsx("td",{className:"px-3 py-2 whitespace-nowrap",children:s+1}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap",children:e.jsx(T,{placeholder:"Nombre de la etapa",disabled:!c,...w(`phases.${s}.name`,{required:"Campo requerido"}),error:h.phases&&((o=(t=h.phases[s])==null?void 0:t.name)==null?void 0:o.message)})}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap",children:e.jsx(B,{onClick:()=>C(s),disabled:!c})})]},a.id??s)})})]}),e.jsx("div",{className:"mt-4",children:e.jsx(q,{"aria-label":"Agregar nueva etapa",onClick:z,disabled:!c})})]})})}),e.jsx(V,{isNew:!1,isEditMode:r,onToggleEdit:()=>j(a=>!a)})]})})}function ue({}){return[{title:"Oportunidad [Etapas]"},{name:"description",content:"Etapas"}]}const he=D(function(){_();const{selectedOpportunity:l}=L(),{phases:p,id:r}=l||{};return e.jsx(e.Fragment,{children:p&&r&&e.jsx(k,{children:e.jsx(H,{mode:"view",defaultValues:{phases:p},idOpportunity:r})})})});export{he as default,ue as meta};
