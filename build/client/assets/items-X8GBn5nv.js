import{w as z,r as b,a as M,j as t}from"./chunk-PVWAREVJ-xN2wnjH-.js";import{u as $,a as P}from"./index.esm-BDlKQGcf.js";import{u as U}from"./UIContext-CTPOFttf.js";import{F as k}from"./FooterForms-D8IvpDVX.js";import{T as B,C as a}from"./TableDetailsQuotes-D5JfbwjB.js";import{I as d}from"./Inputs-nFJy7MmX.js";import{a as Q,b as G}from"./Buttons-RpKxWaSJ.js";import{r as L}from"./functions-kWnBqdLU.js";import{u as H}from"./updatesArraysFields-DUYxr964.js";import{d as h}from"./cruds-C8awoSIz.js";import{u as J}from"./fieldsChange-uPUKat4f.js";import{u as K}from"./DataContext-BJsy23hk.js";import{u as V}from"./ModalsContext-CDMOE33t.js";import"./ContactsContext-CvsXE9G3.js";import"./Buttons-BBIplumE.js";import"./Link-DPrQ_H2S.js";import"./TrashIcon-B0Rn98mB.js";function fe({}){return[{title:"Oportunidad [Cotización]"},{name:"description",content:"Oportunidad [Cotización]"}]}const be=z(function(){const[C,I]=b.useState(!1),{selectedQuoteId:u,activeType:y}=M(),[w,x]=b.useState([]),{openModal:l}=V(),{selectedPhase:i,editByStatus:r}=U(),{selectedOpportunity:A}=K(),{register:c,formState:{dirtyFields:S,isSubmitSuccessful:v,isDirty:j},handleSubmit:N,control:T,watch:p,reset:g}=$(),{fields:D,append:F,remove:O}=P({control:T,name:"items"}),E=async e=>{if(!j){l("INFORMATION",{message:"No hay cambios para actualizar'"});return}l("LOADING",{message:"Procesando requerimiento"});try{const{items:s}=e,o=await H({fieldName:"items",fieldsArray:s,dirtyFields:S,fieldsDelete:w,onInsert:h.insertOne,onRemove:m=>h.remove({id:m}),onUpdate:h.update}),f=s.filter(m=>"id"in m&&typeof m.id=="number");g({items:[...f,...Array.isArray(o)?o:[]]}),x([]),l("SUCCESS",{message:"Se han guardado los datos"})}catch{l("ERROR",{message:"No se pudo actualizar la oportunidad."})}},R=()=>{i&&i>0&&F({id_quote:u,id_phase:i,type:y,item:"",quantity:0,unit_cost:0,notes:"",observations:""})},_=e=>{const o=p("items")[e];o&&"id"in o&&o.id!==void 0&&x(f=>[...f,o.id]),O(e)},{details_items:n}=A||{};b.useEffect(()=>{const e=n==null?void 0:n.filter(s=>s.id_quote===u);e&&g({items:e})},[n,u]);const q=[{groupColsClass:"w-[1%]",label:"#"},{groupColsClass:"",label:"Elemento cotizado"},{groupColsClass:"w-[10%]",label:"Cantidad"},{groupColsClass:"w-[10%]",label:"Costo unitario"},{groupColsClass:"w-[10%]",label:"Total"},{groupColsClass:"w-[1%]",label:"🗑️"}];return J({isSubmitSuccessful:v,isDirty:j}),t.jsx(t.Fragment,{children:i&&t.jsxs("form",{className:" flex flex-col gap-6",onSubmit:N(E),children:[t.jsx("fieldset",{disabled:!C,children:t.jsxs("div",{className:"overflow-x-auto",children:[t.jsx(B,{title:"Tabla Items",columns:q,children:D.map((e,s)=>({...e,index:s})).filter(e=>e.type===y&&e.id_phase===i).map(({index:e,id:s})=>t.jsxs("tr",{className:"*:text-zinc-900 *:first:font-medium dark:*:text-white",children:[t.jsx(a,{children:e+1}),t.jsx(a,{children:t.jsx(d,{...c(`items.${e}.item`),placeholder:"Ítem",disabled:!r})}),t.jsx(a,{children:t.jsx(d,{type:"number",disabled:!r,step:.01,...c(`items.${e}.quantity`,{valueAsNumber:!0})})}),t.jsx(a,{children:t.jsx(d,{disabled:!r,type:"number",...c(`items.${e}.unit_cost`,{valueAsNumber:!0})})}),t.jsx(a,{children:t.jsx(d,{type:"number",placeholder:"Total",readOnly:!0,value:L(p(`items.${e}.quantity`)*p(`items.${e}.unit_cost`),2)||0})}),t.jsx(a,{children:t.jsx(Q,{disabled:!r,onClick:()=>_(e)})})]},s))}),t.jsx(G,{title:"Agregar Item",disabled:!r,onClick:R})]})}),t.jsx(k,{isNew:!1,isEditMode:C,onToggleEdit:()=>I(e=>!e)})]})})});export{be as default,fe as meta};
