import{w as Z,r as j,j as a}from"./chunk-PVWAREVJ-Cl_c9Jt0.js";import{u as ee,a as ae}from"./index.esm-CLpX3RIH.js";import{u as te,c as $}from"./DataContext-B4mtDhe5.js";import{u as re,a as se}from"./UIContext-9PjeG9pu.js";import{F as ie}from"./FooterForms-DUyYdG0J.js";import{T as oe,C as n}from"./TableDetailsQuotes-BoXQZsCR.js";import{I as p}from"./Inputs-cvlDeTHR.js";import{b as le,c as me}from"./Buttons-dijALP0_.js";import{u as ne}from"./updatesArraysFields-CDmdxi8j.js";import{r as ce}from"./functions-llu_GUtd.js";import{S as de}from"./SelectUnits-Bs_i1Q0t.js";import{u as pe}from"./fieldsChange-DvNB-iS-.js";import{M as ue,P as fe}from"./PriceModal-Do_-xRyY.js";import{u as T}from"./useModalState-Dynfoma4.js";import{c as he}from"./QuotesAndBudgetLayout-D5Vah2Mj.js";import"./supabaseClient-O5NoNd5h.js";import"./ContactsContext-BtjVusI7.js";import"./Buttons-C61rKE9q.js";import"./IconComponent-CkWBZZXK.js";import"./index-DvKACyVh.js";import"./TrashIcon-CpHN25SK.js";import"./ModalBase-CQji_mgJ.js";import"./home-DUpfNVgj.js";import"./EntityTable-CYBYbV-K.js";import"./Containers-ZXGJ7diH.js";import"./arrow-left-3CO6tBoR.js";import"./ProtectedRoute-DTKDj7Jz.js";import"./AuthContext-DiXfFtBN.js";import"./allowedRoles-DvcEYYJr.js";import"./LoaderComponent-DzoOhiNN.js";import"./box-BumqmFUH.js";import"./PricesForm-D2xCt5b2.js";import"./realTime-VCRs_Sia.js";import"./ContactsModal-DU5kLlUa.js";function Xe({}){return[{title:"Oportunidad [Cotización]"},{name:"description",content:"Oportunidad [Cotización]"}]}const Ye=Z(function(){var F,O;const[v,k]=j.useState(!1),{openModal:f}=re(),y=T(),c=T(),[w,I]=j.useState([]),[h,x]=j.useState(null),{propsQuoteAndBudget:l}=se(),{selectedProject:M,materials:S}=te(),{register:g,formState:{isSubmitSuccessful:R,isDirty:A,dirtyFields:z,errors:N},handleSubmit:U,control:B,watch:m,setValue:d,reset:D}=ee({defaultValues:{materials:[]}}),{fields:V,append:G,remove:L}=ae({control:B,name:"materials"}),Q=async e=>{if(!A){f("INFORMATION",{title:"Formulario sin cambios",message:"No hay cambios para actualizar'"});return}f("LOADING");try{const{materials:r}=e,t=r.map(({materials:o,prices:_,...b})=>b),s=await ne({fieldName:"materials",fieldsArray:t,dirtyFields:z,fieldsDelete:w,onInsert:$.insertOne,onRemove:o=>$.remove({id:o}),onUpdate:$.update}),i=t.filter(o=>"id"in o&&typeof o.id=="number");D({materials:[...i,...Array.isArray(s)?s:[]]}),I([]),f("SUCCESS",{message:"Se han guardado los datos"})}catch(r){f("ERROR",{message:`No se pudo actualizar la oportunidad. Error: ${String(r)}`})}},H=()=>{l&&l.selsectedPhase>0&&G({id_project:M==null?void 0:M.id,id_phase:l.selsectedPhase,type:"materiales",id_material:0,quantity:0,id_price:0,notes:"",observations:""})},J=e=>{const t=m("materials")[e];t&&"id"in t&&t.id!==void 0&&I(s=>[...s,t.id]),L(e)},{budget_details_materials:C}=M||{};j.useEffect(()=>{C&&D({materials:C})},[C]),pe({isSubmitSuccessful:R,isDirty:A});const K=e=>{x(e);const r=m(`materials.${e}.id_material`),t=S==null?void 0:S.find(i=>i.id===r),s=(t==null?void 0:t.prices)??[];c.openModal({prices:s,idMaterial:r})},W=e=>{x(e),y.openModal()},X=(e,r)=>{const{prices:t,...s}=r,i=t.find(o=>o.default)||{};d(`materials.${e}.materials`,s),d(`materials.${e}.prices`,i),d(`materials.${e}.id_material`,s.id),d(`materials.${e}.id_price`,(i==null?void 0:i.id)||0)},Y=({id:e,price:r})=>{h!==null&&(d(`materials.${h}.prices`,r,{shouldDirty:!0}),d(`materials.${h}.id_price`,e,{shouldDirty:!0}),c.closeModal())};return a.jsx(a.Fragment,{children:(l==null?void 0:l.selsectedPhase)&&a.jsxs(a.Fragment,{children:[a.jsx(oe,{title:"Tabla Materiales",columns:he,handleSubmit:U(Q),isEditMode:v,addElement:a.jsx(me,{disabled:!1,title:"Agregar Material",onClick:H}),footerElement:a.jsx(ie,{isNew:!1,isEditMode:v,onToggleEdit:()=>k(e=>!e)}),children:V.map((e,r)=>({...e,index:r})).filter(e=>e.id_phase===l.selsectedPhase).map(({index:e,id:r})=>{var t,s,i,o,_,b,E,q,P;return a.jsxs("tr",{className:"*:text-zinc-900 *:first:font-medium dark:*:text-white align-baseline",children:[a.jsx(n,{children:e+1}),a.jsxs(n,{children:[a.jsx(p,{disabled:!1,...g(`materials.${e}.id_material`,{required:"Campo requerido",validate:{checkNumber:u=>u>0||"No se ha seleccionado material"}}),className:"sr-only"}),a.jsx(p,{disabled:!1,readOnly:!0,placeholder:"Material",value:m(`materials.${e}.materials.description`)??"",onClick:()=>W(e),error:(i=(s=(t=N.materials)==null?void 0:t[e])==null?void 0:s.id_material)==null?void 0:i.message})]}),a.jsx(n,{children:a.jsx(de,{value:Number(m(`materials.${e}.materials.id_unit`)??0),disabled:!0})}),a.jsx(n,{children:a.jsx(p,{disabled:!1,type:"number",step:.01,...g(`materials.${e}.quantity`,{valueAsNumber:!0,required:"Campo requerido",validate:{checkNumber:u=>u>0||"No se ha seleccionado precio"}}),error:(b=(_=(o=N.materials)==null?void 0:o[e])==null?void 0:_.quantity)==null?void 0:b.message})}),a.jsxs(n,{children:[a.jsx(p,{className:"sr-only",...g(`materials.${e}.id_price`,{required:"Campo requerido",validate:{checkNumber:u=>u>0||"No se ha seleccionado precio"}})}),a.jsx(p,{disabled:!1,readOnly:!0,value:Number(m(`materials.${e}.prices.price`)??0),placeholder:"$ 0.00",onClick:()=>K(e),error:(P=(q=(E=N.materials)==null?void 0:E[e])==null?void 0:q.id_price)==null?void 0:P.message})]}),a.jsx(n,{children:a.jsx(p,{type:"number",placeholder:"Total",readOnly:!0,value:ce((m(`materials.${e}.quantity`)??0)*(m(`materials.${e}.prices.price`)??0),2)})}),a.jsx(n,{children:a.jsx(le,{disabled:!1,onClick:()=>J(e)})})]},r)})}),a.jsx(ue,{activeIndex:h,onSelectMaterial:X,open:y.open,onClose:y.closeModal}),a.jsx(fe,{open:c.open,onClose:c.closeModal,onSelectPrice:Y,prices:((F=c.data)==null?void 0:F.prices)??[],idMaterial:((O=c.data)==null?void 0:O.idMaterial)??0})]})})});export{Ye as default,Xe as meta};
