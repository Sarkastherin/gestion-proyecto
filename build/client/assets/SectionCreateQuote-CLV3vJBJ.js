import{r as m,j as e}from"./chunk-PVWAREVJ-Cl_c9Jt0.js";import{e as P,q as w,d as U,a as L,u as N,s as B}from"./DataContext-BHROWMOn.js";import{B as _}from"./Buttons-DjYWmDVV.js";import{C as k}from"./Cards-BPIQ6iiA.js";import"./Link-DZjWQWvu.js";import{u as F}from"./realTime-Csd-v9-x.js";import{M as O}from"./ModalBase-Czr0Q5I6.js";import{E as T}from"./EntityTable-DKwDIY9O.js";import{a as $}from"./Badge-BNjmnaCE.js";import{u as R}from"./UIContext-9PjeG9pu.js";import{u as G}from"./useModalState-Dynfoma4.js";function V(t,a){if(!t)throw new Error("No se encontr√≥ la oportunidad original.");if(!a)throw new Error("No hay oportunidad seleccionada.")}async function H({oldPhases:t,oldItems:a,oldMaterials:r,id_opportunity:i}){const s=new Set([...a,...r].map(l=>l.id_phase)),o=t.filter(l=>s.has(l.id)),c=o.map(l=>({name:l.name,id_opportunity:i})),{data:n,error:u}=await P.insert(c);if(u)throw new Error(`Error al duplicar fases: ${u.message}`);if(!n||n.length!==o.length)throw new Error("Cantidad de fases duplicadas no coincide.");return{insertedPhases:n,filteredPhases:o}}async function K(t){var o;const a=(o=t.quotes)==null?void 0:o.find(c=>c.active);if(a){const{error:c}=await w.update({id:a.id,values:{active:!1}});if(c)throw new Error(c.message)}const r={id_opportunity:t.id,status:"Abierta",active:!0},{data:i,error:s}=await w.insertOne(r);if(s)throw new Error(`Error al crear la nueva cotizaci√≥n: ${s.message}`);if(!i)throw new Error("No se pudo obtener la nueva cotizaci√≥n creada.");return i}function Y(t,a){if(t.length!==a.length)throw new Error("Cantidad de fases insertadas no coincide con las fases filtradas");return t.reduce((r,i,s)=>(r[i.id]=a[s].id,r),{})}async function J(t,a,r){if(t.length===0)return;const i=t.map(({id:o,created_at:c,...n})=>({...n,id_phase:a[n.id_phase],id_quote:r})),{error:s}=await U.insert(i);if(s)throw new Error(`Error al duplicar √≠tems: ${s.message}`)}async function W(t,a,r){if(t.length===0)return;const i=t.map(({id:o,created_at:c,materials:n,prices:u,...l})=>({...l,id_phase:a[l.id_phase],id_quote:r}));console.log(i);const{error:s}=await L.insert(i);if(console.log(s),s)throw new Error(`Error al duplicar materiales: ${s.message}`)}const X=[{name:"Id",selector:t=>t.id_opportunity,width:"80px"},{name:"Nombre de la Oportunidad",selector:t=>t.opportunity_name},{name:"Monto cotizado",selector:t=>(t.total_quote??0).toLocaleString("es-AR",{style:"currency",currency:"USD"}),sortable:!0},{name:"Status",cell:t=>e.jsx($,{status:t.opportunity_status,children:t.opportunity_status}),width:"120px"}];function Z({open:t,onClose:a}){const{getOpportunityById:r,selectedOpportunity:i,refreshOpportunity:s}=N(),{openModal:o,setProgressiveSteps:c,updateStep:n}=R(),[u,l]=m.useState(null),[f,h]=m.useState([]);m.useEffect(()=>{y()},[]),m.useEffect(()=>{u&&h(u.filter(d=>d.total_quote>0))},[u]);const y=async()=>{B({table:"view_resume_totals",select:"*",setData:l,id_name:"id_opportunity"})},E=[{label:"Obteniendo datos de cotizaci√≥n a duplicar",status:"pending"},{label:"Insertando nuevas fases",status:"pending"},{label:"Creando nueva cotizaci√≥n",status:"pending"},{label:"Duplicando detalles de cotizaci√≥n",status:"pending"},{label:"Duplicando materiales",status:"pending"}],x=d=>{o("CONFIRMATION",{title:"Confirmar Duplicaci√≥n",message:e.jsxs("div",{className:"text-start",children:[e.jsxs("p",{children:["Est√° seleccionando la Oportunidad: ",e.jsx("br",{}),"üíº"," ",e.jsxs("em",{className:"",children:[d.opportunity_name," [",d.id_opportunity,"]"]})]}),e.jsxs("ul",{className:"mt-2 list-inside list-disc",children:[e.jsxs("li",{children:["Materiales:"," ",d.total_materials.toLocaleString("es-AR",{style:"currency",currency:"USD"})]}),e.jsxs("li",{children:["Mano de Obra:"," ",d.total_labor.toLocaleString("es-AR",{style:"currency",currency:"USD"})]}),e.jsxs("li",{children:["Subcontratos:"," ",d.total_subcontracting.toLocaleString("es-AR",{style:"currency",currency:"USD"})]}),e.jsxs("li",{children:["Otros:"," ",d.total_others.toLocaleString("es-AR",{style:"currency",currency:"USD"})]})]}),e.jsxs("p",{className:"font-bold mt-2",children:["Total:"," ",d.total_quote.toLocaleString("es-AR",{style:"currency",currency:"USD"})]}),e.jsx("p",{className:"mt-2 rounded-sm text-center text-yellow-600 font-bold",children:"Esta acci√≥n tambien reemplazar√° las etapas del flujo actual."})]}),onConfirm:async()=>{c(E),o("PROGRESSIVE"),i&&(await g({quote_id:d.quote_id,id_opportunity:d.id_opportunity,selectedOpportunity:i}),s(),o("SUCCESS",{title:"‚úÖ Cotizaci√≥n duplicada con √©xito",message:"La cotizaci√≥n se ha duplicado correctamente."}))}})};async function g({quote_id:d,id_opportunity:M,selectedOpportunity:S}){try{const p=await r(M,!0);if(!p)throw new Error("No se encontr√≥ la oportunidad original.");V(p,S);const{phases:D,details_items:Q,details_materials:A}=p,C=Q.filter(j=>j.id_quote===d),v=A.filter(j=>j.id_quote===d);n(0,"done"),console.log("Ejecutando duplicaci√≥n de fases...");const{insertedPhases:I,filteredPhases:q}=await H({oldPhases:D,oldItems:C,oldMaterials:v,id_opportunity:S.id});n(1,"done");const z=await K(S);n(2,"done");const b=Y(q,I);await J(C,b,z.id),n(3,"done"),await W(v,b,z.id),n(4,"done"),o("SUCCESS",{title:"¬°Todo OK!",message:"Cotizaci√≥n duplicada correctamente"})}catch(p){o("ERROR",{title:"Error al duplicar cotizaci√≥n",message:p instanceof Error?p.message:"Error desconocido"})}}return e.jsx(O,{title:"Listado de Cotizaciones",open:t,zIndex:50,onClose:a,width:"max-w-4xl",footer:{btnSecondary:{label:"Cancelar",handleOnClick:a}},children:e.jsx("div",{className:"px-6 pt-6 overflow-y-auto",style:{maxHeight:"calc(100vh - 270px)"},children:e.jsx(T,{columns:X,data:f,onRowClick:x,filterFields:[{key:"opportunity_name",label:"Buscar por descripci√≥n",autoFilter:!0}]})})})}const ee=({title:t,message:a,children:r})=>e.jsx("section",{className:"max-w-md mx-auto px-6 py-4 mt-12",children:e.jsx(k,{children:e.jsxs("div",{className:"flex flex-col items-center justify-center gap-4",children:[e.jsx("h2",{className:"text-lg font-semibold",children:t}),e.jsx("p",{children:a}),r]})})});function me(){return e.jsx(ee,{title:"Sin Cotizaci√≥n",message:"Crea una nueva cotizaci√≥n para esta oportunidad",children:e.jsx(te,{})})}function te({label:t="Crear cotizaci√≥n"}){F();const{openModal:a}=R(),r=G(),[i,s]=m.useState(!1),{selectedOpportunity:o}=N(),{quotes:c}=o||{},n=async()=>{try{if(o){if(c&&c.length>0){const h=c.find(g=>g.active===!0);if(!h)return;const y=h.id;if(!window.confirm("Ya existe una cotizaci√≥n activa. ¬øQuer√©s reemplazarla con una nueva?"))return;const{error:x}=await w.update({id:y,values:{active:!1}});if(x)throw new Error(x.message)}a("LOADING",{message:"Creando cotizaci√≥n"});const l={id_opportunity:o.id,status:"Abierta",active:!0},{error:f}=await w.insertOne(l);if(f)throw new Error(f.message);a("SUCCESS",{message:"Cotizaci√≥n inicializada"})}}catch(l){a("ERROR",{message:"Problemas al intentar crear la cotizaci√≥n",code:String(l)})}},u=()=>{s(!1),r.openModal()};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-fit",children:e.jsx(_,{onClick:()=>s(!0),children:t})}),e.jsx(O,{open:i,onClose:()=>s(!1),title:"Crear nueva cotizaci√≥n",zIndex:50,children:e.jsxs("div",{className:"flex flex-col gap-4 mt-6",children:[e.jsx("p",{className:"text-sm",children:"Puedes comenzar una cotizaci√≥n desde cero:"}),e.jsx("span",{className:"mx-auto text-center",children:e.jsx(_,{variant:"yellow",onClick:n,children:"Crear en blanco"})}),e.jsx("p",{className:"text-sm",children:"o duplicar una cotizaci√≥n existente. Se copiar√°n todos los detalles, y se reemplazar√°n las etapas del flujo actual."}),e.jsx("span",{className:"mx-auto text-center",children:e.jsx(_,{variant:"blue",onClick:u,children:"Duplicar cotizaci√≥n"})})]})}),e.jsx(Z,{open:r.open,onClose:r.closeModal})]})}export{te as B,me as S};
