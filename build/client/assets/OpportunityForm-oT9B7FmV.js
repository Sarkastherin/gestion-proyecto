var K=Object.defineProperty;var W=(t,e,r)=>e in t?K(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var F=(t,e,r)=>W(t,typeof e!="symbol"?e+"":e,r);import{r as N,u as X,j as i}from"./chunk-PVWAREVJ-Cl_c9Jt0.js";import{I as P,T as V,S as Y}from"./Inputs-cvlDeTHR.js";import{S as Z}from"./StatusOptions-C3TsQ3Nf.js";import{a as D}from"./Cards-BPIQ6iiA.js";import{u as Q}from"./index.esm-CLpX3RIH.js";import{u as ee,a as re}from"./UIContext-9PjeG9pu.js";import{f as te,o as O,g as ae,b as se,c as oe,u as ie}from"./DataContext-B4mtDhe5.js";import{F as ne}from"./FooterForms-DUyYdG0J.js";import{u as de}from"./updatesSingleRow-C5gkTyzt.js";import{u as ce}from"./fieldsChange-DvNB-iS-.js";import{u as le}from"./useModalState-Dynfoma4.js";import{C as ue}from"./ContactsModal-DU5kLlUa.js";class p extends Error{constructor(r,s){super(s);F(this,"step");this.name="ProjectCreationError",this.step=r}}function pe(t,e){var s;if(!t)throw new p("Validación","No hay una cotización seleccionada");if(!e)throw new p("Validación","No se seleccionó ninguna oportunidad");const r=(s=e.quotes)==null?void 0:s.find(n=>n.id===t);if(!r)throw new p("Validación","No se encontró la cotización seleccionada");return r}function me(t,e){var s;const r=(s=t.name)==null?void 0:s.trim();if(!r)throw new p("Validación","El nombre del proyecto es obligatorio");return{name:r,id_opportunity:t.id,id_quote:e.id,id_client:t.id_client,scope:t.scope||"",method_payment:e.method_payment,guarantee:e.guarantee,materials:e.materials,labor:e.labor,subcontracting:e.subcontracting,others:e.others,general:e.general}}async function fe(t,e){const{data:r,error:s}=await te.insertOne(t);if(s||!r||!("id"in r))throw new p("Creación de proyecto","Error al crear proyecto");const n=r.id,{error:d}=await O.update({id:e.id,values:{id_project:n}});if(d)throw new p("Actualización de oportunidad","Error al actualizar oportunidad");return n}async function ge(t,e,r,s){const n=new Set([...e,...r].map(a=>a.id_phase)),d=t.filter(a=>n.has(a.id));if(d.length===0)throw new p("Creación de fases","Cantidad de fases creadas no coincide");const g=d.map(a=>{var f;return{name:(f=a.name)==null?void 0:f.trim(),id_project:s}}),{data:o,error:E}=await ae.insert(g);if(E||!o||o.length!==d.length)throw new p("Creación de fases","Error al crear fases");return d.reduce((a,f,m)=>(a[f.id]=o[m].id,a),{})}async function he(t,e,r){if(t.length===0)return;const s=t.map(({id:d,created_at:g,...o})=>({...o,id_phase:e[o.id_phase],id_project:r})),{error:n}=await se.insert(s);if(n)throw new p("Presupuesto - Ítems","Error al crear ítems del presupuesto")}async function we(t,e,r){if(t.length===0)return;const s=t.map(({id:d,created_at:g,materials:o,prices:E,...a})=>({...a,id_phase:e[a.id_phase],id_project:r})),{error:n}=await oe.insert(s);if(n)throw new p("Presupuesto - Materiales","Error al crear materiales del presupuesto")}function Ae({defaultValues:t,isNew:e,selectedQuoteId:r,initialEditMode:s}){var M,I,v,A;const n=le(),[d,g]=N.useState(s),{openModal:o,setProgressiveSteps:E,updateStep:a}=ee(),f=X(),{selectedClient:m,editByStatus:S}=re(),{selectedOpportunity:y,getOpportunities:z}=ie(),{register:h,watch:w,formState:{errors:j,dirtyFields:L,isSubmitSuccessful:q,isDirty:T},setValue:U,handleSubmit:G}=Q({defaultValues:t??{name:"",id_client:void 0,status:"",created_by:""}}),$=[{label:"Creando proyecto",status:"pending"},{label:"Creando fases",status:"pending"},{label:"Insertando ítems",status:"pending"},{label:"Insertando materiales",status:"pending"}];ce({isSubmitSuccessful:q,isDirty:T}),N.useEffect(()=>{m&&m.id!==w("id_client")&&U("id_client",m.id,{shouldDirty:!0})},[m]);const B=async l=>{try{if(e){o("LOADING",{title:"Guardando oportunidad",message:"Por favor, espere..."});const{data:c,error:u}=await O.insertOne(l);if(u||!c||!("id"in c))throw new Error("Error al crear oportunidad");o("SUCCESS",{title:"Oportunidad creada con éxito",message:"La oportunidad se ha creado correctamente."}),z(),f(`/opportunities/${c.id}/resumen`)}if(!e)if(o("LOADING",{title:"Actualizando oportunidad",message:"Por favor, espere..."}),await de({dirtyFields:Object.fromEntries(Object.entries(L).filter(([c,u])=>typeof u=="boolean")),formData:l,onUpdate:O.update}),l.status==="Ganada"&&r&&y&&y.id_project===null)if(E($),o("PROGRESSIVE"),"id"in l&&"created_at"in l){const c=await k({formData:l,selectedOpportunity:y});o("SUCCESS",{title:"✅ Proyecto creado con éxito",message:"El proyecto se ha creado correctamente."})}else throw new Error("Los datos de la oportunidad no son válidos para crear un proyecto");else o("SUCCESS",{title:"Oportunidad actualizada",message:"La oportunidad se ha actualizado correctamente."})}catch(c){o("ERROR",{title:"Error al guardar oportunidad",message:String(c)})}};async function k({formData:l,selectedOpportunity:c}){try{a(0,"done");const u=pe(r,c),b=me(l,u),_=await fe(b,l);a(1,"in-progress");const R=await ge(c.phases,c.details_items,c.details_materials,_);a(1,"done"),a(2,"in-progress");const H=c.details_items.filter(C=>C.id_quote===r);await he(H,R,_),a(2,"done"),a(3,"in-progress");const J=c.details_materials.filter(C=>C.id_quote===r);return await we(J,R,_),a(3,"done"),_}catch(u){let b="Ocurrió un error desconocido";return u instanceof p?b=`Error en ${u.step}: ${u.message}`:u instanceof Error&&(b=`Error inesperado: ${u.message}`),o("ERROR",{title:"Error al crear el proyecto",message:b}),null}}const x=w("status")==="Perdida"||w("status")==="Vencida"||w("status")==="Desestimada";return i.jsxs(i.Fragment,{children:[i.jsxs("form",{className:" flex flex-col gap-6",onSubmit:G(B),children:[i.jsx("fieldset",{disabled:!d,children:i.jsx(D,{title:"Datos de la Oportunidad",children:i.jsxs("div",{className:"flex flex-col gap-4",children:[i.jsx(P,{label:"Nombre de Oportunidad",placeholder:"Ingresa un nombre para la oportunidad",disabled:!S&&!d,...h("name",{required:"Campo requerido"}),error:(M=j.name)==null?void 0:M.message}),i.jsx(P,{label:"Cliente",placeholder:"Seleccione un cliente",readOnly:!0,disabled:!S&&!d,value:(m==null?void 0:m.nombre)||"",onClick:()=>{n.openModal()},error:(I=j.id_client)==null?void 0:I.message}),i.jsx(P,{type:"hidden",...h("id_client",{required:!0,valueAsNumber:!0})}),i.jsx(V,{disabled:!S&&!d,label:"Alcance",...h("scope")}),i.jsx(Y,{label:"Status",selectText:"Selecciona un status",defaultValue:"Nuevo",...h("status",{required:!0}),error:(v=j.status)==null?void 0:v.message,children:i.jsx(Z,{})}),x&&i.jsx(V,{disabled:!x,label:`Razón de status: ${w("status")}`,...h("loss_reason",{required:{value:x,message:"Campo requerido"}}),error:(A=j.loss_reason)==null?void 0:A.message})]})})}),i.jsx(ne,{isNew:e,isEditMode:d,onToggleEdit:()=>g(l=>!l)})]}),i.jsx(ue,{open:n.open,onClose:n.closeModal,type:"client"})]})}export{Ae as O};
