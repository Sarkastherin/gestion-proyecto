import{r as c,j as dt}from"./chunk-PVWAREVJ-xN2wnjH-.js";import{s as E,a as pt}from"./UIContext-DAvkThde.js";import{g as ft,r as _}from"./functions-DVvIYcXa.js";async function W({table:r,select:e,id_name:u}){let a=[],o=0;const d=1e3;for(;;){const{data:s,error:m}=await E.from(r).select(e).order(u||"id",{ascending:!1}).range(o,o+d-1);if(m)throw new Error(`Error al obtener datos de ${r}: ${m.message}`);if(!s||s.length===0||(a=a.concat(s),o+=d,s.length<d))break}return a}async function f({table:r,select:e,setData:u,clients:a,clientKey:o,id_name:d}){if(a&&o){const s=await mt({table:r,select:e,clientKey:o,clients:a});return u(s),s}else{const s=await W({table:r,select:e,id_name:d});return u(s),s}}async function mt({table:r,select:e,clientKey:u,clients:a}){let o=await W({table:r,select:e});return a&&a.length>0&&u&&(o=o.map(s=>{const m=s[u],w=a.find(j=>j.id===m);return w?{...s,client:w}:null}).filter(s=>s!==null)),o}const G=c.createContext(void 0),wt=({children:r})=>{const{clients:e}=pt(),[u,a]=c.useState(null),[o,d]=c.useState(null),[s,m]=c.useState(null),[w,j]=c.useState(null),[H,J]=c.useState(null),[K,L]=c.useState(null),[V,X]=c.useState(null),[D,M]=c.useState(null),[Y,Z]=c.useState(null),[x,C]=c.useState(null),tt=async()=>{e&&f({table:"projects",select:"*, users(*)",clientKey:"id_client",clients:e,setData:a})},et=async()=>{e&&f({table:"opportunities",select:"*, users(*)",clientKey:"id_client",clients:e,setData:d})},O=async()=>f({table:"materials",select:"*, prices(*), view_categorizations(*)",setData:X}),st=async()=>f({table:"units",select:"*",setData:m}),rt=async()=>f({table:"families",select:"*",setData:j}),at=async()=>f({table:"categories",select:"*",setData:J}),ot=async()=>f({table:"subcategories",select:"*",setData:L}),Q=async(p,l)=>{try{const{data:t,error:n}=await E.from("opportunities").select("*, phases(*), quotes(*)").eq("id",p).single();if(n||!t)throw new Error("No se pudo obtener la oportunidad");const y=e==null?void 0:e.find(P=>P.id===t.id_client);if(!y)throw new Error("Cliente no encontrado");const b=Array.isArray(t.quotes)&&t.quotes.length>0;let S={details_items:[],details_materials:[]};if(b){const P=t.quotes.map(v=>v.id),{data:g,error:B}=await E.from("quotes").select("details_items(*), details_materials(*,materials:id_material(*),prices:id_price(*))").in("id",P);if(B)throw new Error(`Error al obtener detalles de quotes: ${B.message}`);if(g!=null&&g.length){const lt=t.quotes.map(i=>{const T=g.find(N=>{var R,U;return(((R=N.details_items[0])==null?void 0:R.id_quote)??((U=N.details_materials[0])==null?void 0:U.id_quote))===i.id});if(!T)return i;const h=ft(T),$=_(h.total_materials*((i.materials??0)/100+1),2),k=_(h.total_labor*((i.labor??0)/100+1),2),z=_(h.total_subcontracting*((i.subcontracting??0)/100+1),2),A=_(h.total_others*((i.others??0)/100+1),2),F=_($+k+z+A,2),ut=_(F*((i.general??0)/100+1),2);return{...i,...h,t_mg_materials:$,t_mg_labor:k,t_mg_subcontracting:z,t_mg_others:A,total:F,t_mg_total:ut}});t.quotes=lt,S={details_items:g.flatMap(i=>i.details_items??[]),details_materials:g.flatMap(i=>i.details_materials??[])}}}const I={...t,client:y,...S};return l||M(I),I}catch(t){return console.error("Error en getOpportunityById:",t),null}},nt=async(p,l)=>{try{const{data:t,error:n}=await E.from("projects").select("*, phases_project(*), budget_details_items(*), budget_details_materials(*)").eq("id",p).single();if(n||!t)throw new Error("No se pudo obtener el proyecto");const y=e==null?void 0:e.find(S=>S.id===t.id_client);if(!y)throw new Error("Cliente no encontrado");const b={...t,client:y};return Z(b),b}catch(t){return console.error("Error en getProjectById:",t),null}},q=(p,l)=>{const t=l.find(n=>n.id===p);C(t||null)},it=async()=>{if(!D)return;const{id:p}=D,l=await Q(p);l&&d(t=>(t==null?void 0:t.map(n=>n.id===l.id?l:n))??[])},ct=async p=>{const{id:l}=x||{},t=l||p;if(!t)return;const n=await O();!n||n.length===0||q(t,n)};return dt.jsx(G.Provider,{value:{getProjects:tt,projects:u,getOpportunities:et,opportunities:o,getMaterials:O,materials:V,getOpportunityById:Q,selectedOpportunity:D,refreshOpportunity:it,setSelectedOpportunity:M,refreshMaterial:ct,getMaterial:q,getUnits:st,units:s,getFamilies:rt,families:w,getCategories:at,categories:H,getSubcategories:ot,subcategories:K,selectedMaterial:x,setSelectedMaterial:C,getProjectById:nt,selectedProject:Y},children:r})},bt=()=>{const r=c.useContext(G);if(r===void 0)throw new Error("useData must be used within a DataProvider");return r};export{wt as D,f as s,bt as u};
