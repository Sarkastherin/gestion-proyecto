import{r as f,j as e,w as D}from"./chunk-PVWAREVJ-xN2wnjH-.js";import{u as O}from"./UIContext-DAvkThde.js";import{a as R}from"./Containers-PvQTCG8J.js";import{I as k}from"./Inputs-nFJy7MmX.js";import{a as T}from"./Cards-BrE1Rw6C.js";import{u as M,a as P}from"./index.esm-BDlKQGcf.js";import{a as U,b as B}from"./Buttons-CDHNjhxE.js";import{u as q}from"./updatesArraysFields-DUYxr964.js";import{u as $}from"./fieldsChange-bFwPspdM.js";import{a as c}from"./cruds-CKZRngPt.js";import{F as G}from"./FooterForms-Cn13FOqk.js";import{u as L}from"./ModalsContext-CDMOE33t.js";import{u as V}from"./realTime-CTR1wkWo.js";import{u as _}from"./DataContext-BsNWaLsj.js";import"./Buttons-BBIplumE.js";import"./Link-DPrQ_H2S.js";import"./functions-DVvIYcXa.js";import"./TrashIcon-B0Rn98mB.js";function H({defaultValues:d,idOpportunity:l,mode:p}){const[r,j]=f.useState(!1),[y,u]=f.useState([]),{editByStatus:m}=O(),{openModal:i}=L(),{register:w,formState:{errors:h,dirtyFields:N,isSubmitSuccessful:g,isDirty:x},control:b,handleSubmit:v,reset:F}=M({defaultValues:d??{phases:[]}}),{fields:S,append:E,remove:A}=P({control:b,name:"phases"}),I=async a=>{if(!x){i("INFORMATION",{title:"Formulario sin cambios",message:"No hay cambios para actualizar'"});return}i("LOADING");try{const{phases:s}=a,t=await q({fieldName:"phases",fieldsArray:s,dirtyFields:N,fieldsDelete:y,onInsert:c.insertOne,onRemove:n=>c.remove({id:n}),onUpdate:c.update});i("SUCCESS",{message:"Se ha actualizado la oportunidad"});const o=s.filter(n=>"id"in n&&typeof n.id=="number");F({phases:[...o,...Array.isArray(t)?t:[]]}),u([])}catch(s){i("ERROR",{message:`No se pudo actualizar la oportunidad. Error: ${String(s)}`})}},z=()=>{E({id_opportunity:l??null,name:""})},C=a=>{const s=d.phases[a];A(a),s&&"id"in s&&s.id!==void 0&&u(t=>[...t,s.id])};return $({isSubmitSuccessful:g,isDirty:x}),e.jsx(e.Fragment,{children:e.jsxs("form",{className:" flex flex-col gap-6",onSubmit:v(I),children:[e.jsx("fieldset",{disabled:!r,children:e.jsx(T,{title:"Etapas",children:e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("table",{className:"min-w-full table-auto divide-y-2 divide-zinc-200 dark:divide-zinc-700",children:[e.jsxs("colgroup",{children:[e.jsx("col",{className:"w-[1%]"}),e.jsx("col",{}),e.jsx("col",{className:"w-[1%]"})]}),e.jsx("thead",{className:"ltr:text-left rtl:text-right",children:e.jsxs("tr",{className:"*:font-medium *:text-zinc-900 dark:*:text-white",children:[e.jsx("th",{className:"px-3 py-2 whitespace-nowrap",children:"#"}),e.jsx("th",{className:"px-3 py-2 whitespace-nowrap",children:"Etapas"}),e.jsx("th",{className:"px-3 py-2 whitespace-nowrap",children:"🗑️"})]})}),e.jsx("tbody",{className:"divide-y divide-zinc-200 dark:divide-zinc-700",children:S.map((a,s)=>{var t,o;return e.jsxs("tr",{className:"*:text-zinc-900 *:first:font-medium dark:*:text-white",children:[e.jsx("td",{className:"px-3 py-2 whitespace-nowrap",children:s+1}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap",children:e.jsx(k,{placeholder:"Nombre de la etapa",disabled:!m,...w(`phases.${s}.name`,{required:"Campo requerido"}),error:h.phases&&((o=(t=h.phases[s])==null?void 0:t.name)==null?void 0:o.message)})}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap",children:e.jsx(U,{onClick:()=>C(s),disabled:!m})})]},a.id??s)})})]}),e.jsx("div",{className:"mt-4",children:e.jsx(B,{"aria-label":"Agregar nueva etapa",onClick:z,disabled:!m})})]})})}),e.jsx(G,{isNew:!1,isEditMode:r,onToggleEdit:()=>j(a=>!a)})]})})}function me({}){return[{title:"Oportunidad [Etapas]"},{name:"description",content:"Etapas"}]}const ce=D(function(){V();const{selectedOpportunity:l}=_(),{phases:p,id:r}=l||{};return e.jsx(e.Fragment,{children:p&&r&&e.jsx(R,{children:e.jsx(H,{mode:"view",defaultValues:{phases:p},idOpportunity:r})})})});export{ce as default,me as meta};
