import{r as m,j as e}from"./chunk-PVWAREVJ-xN2wnjH-.js";import{a as P,q as w,d as U,i as B}from"./cruds-C8awoSIz.js";import{B as _}from"./Buttons-BBIplumE.js";import{C as L}from"./Cards-BrE1Rw6C.js";import"./Link-DPrQ_H2S.js";import{u as k}from"./realTime-CHJ-WwWR.js";import{u as N,s as F}from"./DataContext-BJsy23hk.js";import{M as O}from"./ModalBase-Cfo712yZ.js";import{E as T}from"./EntityTable-BPgGIcNJ.js";import{B as $}from"./Badge-CULYdmWM.js";import{u as M}from"./ModalsContext-CDMOE33t.js";import{u as G}from"./useModalState-DqEB_XcK.js";function V(t,a){if(!t)throw new Error("No se encontr√≥ la oportunidad original.");if(!a)throw new Error("No hay oportunidad seleccionada.")}async function H({oldPhases:t,oldItems:a,oldMaterials:i,id_opportunity:n}){const o=new Set([...a,...i].map(l=>l.id_phase)),s=t.filter(l=>o.has(l.id)),c=s.map(l=>({name:l.name,id_opportunity:n})),{data:r,error:u}=await P.insert(c);if(u)throw new Error(`Error al duplicar fases: ${u.message}`);if(!r||r.length!==s.length)throw new Error("Cantidad de fases duplicadas no coincide.");return{insertedPhases:r,filteredPhases:s}}async function K(t){var s;const a=(s=t.quotes)==null?void 0:s.find(c=>c.active);if(a){const{error:c}=await w.update({id:a.id,values:{active:!1}});if(c)throw new Error(c.message)}const i={id_opportunity:t.id,status:"Abierta",active:!0},{data:n,error:o}=await w.insertOne(i);if(o)throw new Error(`Error al crear la nueva cotizaci√≥n: ${o.message}`);if(!n)throw new Error("No se pudo obtener la nueva cotizaci√≥n creada.");return n}function Y(t,a){if(t.length!==a.length)throw new Error("Cantidad de fases insertadas no coincide con las fases filtradas");return t.reduce((i,n,o)=>(i[n.id]=a[o].id,i),{})}async function J(t,a,i){if(t.length===0)return;const n=t.map(({id:s,created_at:c,...r})=>({...r,id_phase:a[r.id_phase],id_quote:i})),{error:o}=await U.insert(n);if(o)throw new Error(`Error al duplicar √≠tems: ${o.message}`)}async function W(t,a,i){if(t.length===0)return;const n=t.map(({id:s,created_at:c,materials:r,prices:u,...l})=>({...l,id_phase:a[l.id_phase],id_quote:i}));console.log(n);const{error:o}=await B.insert(n);if(console.log(o),o)throw new Error(`Error al duplicar materiales: ${o.message}`)}const X=[{name:"Id",selector:t=>t.id_opportunity,width:"80px"},{name:"Nombre de la Oportunidad",selector:t=>t.opportunity_name},{name:"Monto cotizado",selector:t=>(t.total_quote??0).toLocaleString("es-AR",{style:"currency",currency:"USD"}),sortable:!0},{name:"Status",cell:t=>e.jsx($,{variant:t.opportunity_status,children:t.opportunity_status}),width:"120px"}];function Z({open:t,onClose:a}){const{getOpportunityById:i,selectedOpportunity:n,refreshOpportunity:o}=N(),{openModal:s,setProgressiveSteps:c,updateStep:r}=M(),[u,l]=m.useState(null),[f,h]=m.useState([]);m.useEffect(()=>{y()},[]),m.useEffect(()=>{u&&h(u.filter(d=>d.total_quote>0))},[u]);const y=async()=>{F({table:"view_resume_totals",select:"*",setData:l,id_name:"id_opportunity"})},C=[{label:"Obteniendo datos de cotizaci√≥n a duplicar",status:"pending"},{label:"Insertando nuevas fases",status:"pending"},{label:"Creando nueva cotizaci√≥n",status:"pending"},{label:"Duplicando detalles de cotizaci√≥n",status:"pending"},{label:"Duplicando materiales",status:"pending"}],x=d=>{s("CONFIRMATION",{title:"Confirmar Duplicaci√≥n",message:e.jsxs("div",{className:"text-start",children:[e.jsxs("p",{children:["Est√° seleccionando la Oportunidad: ",e.jsx("br",{}),"üíº"," ",e.jsxs("em",{className:"",children:[d.opportunity_name," [",d.id_opportunity,"]"]})]}),e.jsxs("ul",{className:"mt-2 list-inside list-disc",children:[e.jsxs("li",{children:["Materiales:"," ",d.total_materials.toLocaleString("es-AR",{style:"currency",currency:"USD"})]}),e.jsxs("li",{children:["Mano de Obra:"," ",d.total_labor.toLocaleString("es-AR",{style:"currency",currency:"USD"})]}),e.jsxs("li",{children:["Subcontratos:"," ",d.total_subcontracting.toLocaleString("es-AR",{style:"currency",currency:"USD"})]}),e.jsxs("li",{children:["Otros:"," ",d.total_others.toLocaleString("es-AR",{style:"currency",currency:"USD"})]})]}),e.jsxs("p",{className:"font-bold mt-2",children:["Total:"," ",d.total_quote.toLocaleString("es-AR",{style:"currency",currency:"USD"})]}),e.jsx("p",{className:"mt-2 rounded-sm text-center text-yellow-600 font-bold",children:"Esta acci√≥n tambien reemplazar√° las etapas del flujo actual."})]}),onConfirm:async()=>{c(C),s("PROGRESSIVE"),n&&(await g({quote_id:d.quote_id,id_opportunity:d.id_opportunity,selectedOpportunity:n}),o(),s("SUCCESS",{title:"‚úÖ Cotizaci√≥n duplicada con √©xito",message:"La cotizaci√≥n se ha duplicado correctamente."}))}})};async function g({quote_id:d,id_opportunity:R,selectedOpportunity:j}){try{console.log("Ejecutando duplicaci√≥n de cotizaci√≥n...");const p=await i(R,!0);if(!p)throw new Error("No se encontr√≥ la oportunidad original.");V(p,j);const{phases:D,details_items:Q,details_materials:A}=p,v=Q.filter(S=>S.id_quote===d),z=A.filter(S=>S.id_quote===d);r(0,"done"),console.log("Ejecutando duplicaci√≥n de fases...");const{insertedPhases:I,filteredPhases:q}=await H({oldPhases:D,oldItems:v,oldMaterials:z,id_opportunity:j.id});r(1,"done"),console.log("Ejecutando duplicaci√≥n de cotizaci√≥n...");const b=await K(j);r(2,"done");const E=Y(q,I);console.log(E),console.log("Ejecutando duplicaci√≥n de √≠tems..."),await J(v,E,b.id),r(3,"done"),console.log("Ejecutando duplicaci√≥n de materiales..."),await W(z,E,b.id),console.log("finalizado duplicateMaterials..."),r(4,"done"),s("SUCCESS",{title:"¬°Todo OK!",message:"Cotizaci√≥n duplicada correctamente"})}catch(p){s("ERROR",{title:"Error al duplicar cotizaci√≥n",message:p instanceof Error?p.message:"Error desconocido"})}}return e.jsx(O,{title:"Listado de Cotizaciones",open:t,zIndex:40,onClose:a,width:"max-w-4xl",footer:{btnSecondary:{label:"Cancelar",handleOnClick:a}},children:e.jsx("div",{className:"px-6 pt-6 overflow-y-auto",style:{maxHeight:"calc(100vh - 270px)"},children:e.jsx(T,{columns:X,data:f,onRowClick:x,filterFields:[{key:"opportunity_name",label:"Buscar por descripci√≥n",autoFilter:!0}]})})})}const ee=({title:t,message:a,children:i})=>e.jsx("section",{className:"max-w-md mx-auto px-6 py-4 mt-12",children:e.jsx(L,{children:e.jsxs("div",{className:"flex flex-col items-center justify-center gap-4",children:[e.jsx("h2",{className:"text-lg font-semibold",children:t}),e.jsx("p",{children:a}),i]})})});function fe(){return e.jsx(ee,{title:"Sin Cotizaci√≥n",message:"Crea una nueva cotizaci√≥n para esta oportunidad",children:e.jsx(te,{})})}function te({label:t="Crear cotizaci√≥n"}){k();const{openModal:a}=M(),i=G(),[n,o]=m.useState(!1),{selectedOpportunity:s}=N(),{quotes:c}=s||{},r=async()=>{try{if(s){if(c&&c.length>0){const h=c.find(g=>g.active===!0);if(!h)return;const y=h.id;if(!window.confirm("Ya existe una cotizaci√≥n activa. ¬øQuer√©s reemplazarla con una nueva?"))return;const{error:x}=await w.update({id:y,values:{active:!1}});if(x)throw new Error(x.message)}a("LOADING",{message:"Creando cotizaci√≥n"});const l={id_opportunity:s.id,status:"Abierta",active:!0},{error:f}=await w.insertOne(l);if(f)throw new Error(f.message);a("SUCCESS",{message:"Cotizaci√≥n inicializada"})}}catch(l){a("ERROR",{message:"Problemas al intentar crear la cotizaci√≥n",code:String(l)})}},u=()=>{o(!1),i.openModal()};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-42",children:e.jsx(_,{onClick:()=>o(!0),children:t})}),e.jsx(O,{open:n,onClose:()=>o(!1),title:"Crear nueva cotizaci√≥n",zIndex:50,children:e.jsxs("div",{className:"flex flex-col gap-4 mt-6",children:[e.jsx("p",{className:"text-sm",children:"Puedes comenzar una cotizaci√≥n desde cero:"}),e.jsx("span",{className:"mx-auto text-center",children:e.jsx(_,{variant:"yellow",onClick:r,children:"Crear en blanco"})}),e.jsx("p",{className:"text-sm",children:"o duplicar una cotizaci√≥n existente. Se copiar√°n todos los detalles, y se reemplazar√°n las etapas del flujo actual."}),e.jsx("span",{className:"mx-auto text-center",children:e.jsx(_,{variant:"blue",onClick:u,children:"Duplicar cotizaci√≥n"})})]})}),e.jsx(Z,{open:i.open,onClose:i.closeModal})]})}export{te as B,fe as S};
